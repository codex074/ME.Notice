<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบรายงานอุบัติการณ์ ME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Sarabun', 'sans-serif'], }, colors: { brand: { blue: '#4A90E2', light: '#F0F4F8', } }, screens: { 'xs': '375px', } } } }
    </script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            overscroll-behavior-y: none;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .btn-type {
            transition: all 0.2s;
            position: relative;
        }

        .btn-type:active {
            transform: scale(0.95);
        }

        .btn-type.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px -3px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .checkmark {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10B981;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        .btn-type.selected .checkmark {
            opacity: 1;
            transform: scale(1);
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #reader video {
            object-fit: cover;
            border-radius: 10px;
            width: 100% !important;
            height: 100% !important;
        }

        .no-break {
            whitespace: nowrap;
        }

        /* Spinner CSS (สำหรับ Modal) */
        .spinner {
            font-size: 28px;
            position: relative;
            display: inline-block;
            width: 1em;
            height: 1em;
        }

        .spinner.center {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            z-index: 5;
        }

        .spinner .spinner-blade {
            position: absolute;
            left: 0.4629em;
            bottom: 0;
            width: 0.074em;
            height: 0.2777em;
            border-radius: 0.0555em;
            background-color: transparent;
            transform-origin: center -0.2222em;
            animation: spinner-fade9234 1s infinite linear;
        }

        .spinner .spinner-blade:nth-child(1) {
            animation-delay: 0s;
            transform: rotate(0deg);
        }

        .spinner .spinner-blade:nth-child(2) {
            animation-delay: 0.083s;
            transform: rotate(30deg);
        }

        .spinner .spinner-blade:nth-child(3) {
            animation-delay: 0.166s;
            transform: rotate(60deg);
        }

        .spinner .spinner-blade:nth-child(4) {
            animation-delay: 0.249s;
            transform: rotate(90deg);
        }

        .spinner .spinner-blade:nth-child(5) {
            animation-delay: 0.332s;
            transform: rotate(120deg);
        }

        .spinner .spinner-blade:nth-child(6) {
            animation-delay: 0.415s;
            transform: rotate(150deg);
        }

        .spinner .spinner-blade:nth-child(7) {
            animation-delay: 0.498s;
            transform: rotate(180deg);
        }

        .spinner .spinner-blade:nth-child(8) {
            animation-delay: 0.581s;
            transform: rotate(210deg);
        }

        .spinner .spinner-blade:nth-child(9) {
            animation-delay: 0.664s;
            transform: rotate(240deg);
        }

        .spinner .spinner-blade:nth-child(10) {
            animation-delay: 0.747s;
            transform: rotate(270deg);
        }

        .spinner .spinner-blade:nth-child(11) {
            animation-delay: 0.83s;
            transform: rotate(300deg);
        }

        .spinner .spinner-blade:nth-child(12) {
            animation-delay: 0.913s;
            transform: rotate(330deg);
        }

        @keyframes spinner-fade9234 {
            0% {
                background-color: #69717d;
            }

            100% {
                background-color: transparent;
            }
        }

        /* Folder Upload CSS */
        .upload-box {
            --transition: 350ms;
            --folder-W: 100px;
            --folder-H: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: 10px;
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            height: calc(var(--folder-H) * 2.2);
            position: relative;
            width: 100%;
            max-width: 280px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .folder {
            position: absolute;
            top: -15px;
            left: calc(50% - 50px);
            animation: float 2.5s infinite ease-in-out;
            transition: transform var(--transition) ease;
        }

        .folder:hover {
            transform: scale(1.05);
        }

        .folder .front-side,
        .folder .back-side {
            position: absolute;
            transition: transform var(--transition);
            transform-origin: bottom center;
        }

        .folder .back-side::before,
        .folder .back-side::after {
            content: "";
            display: block;
            background-color: white;
            opacity: 0.5;
            width: var(--folder-W);
            height: var(--folder-H);
            position: absolute;
            transform-origin: bottom center;
            border-radius: 15px;
            transition: transform 350ms;
            z-index: 0;
        }

        .upload-box:hover .back-side::before {
            transform: rotateX(-5deg) skewX(5deg);
        }

        .upload-box:hover .back-side::after {
            transform: rotateX(-15deg) skewX(12deg);
        }

        .folder .front-side {
            z-index: 1;
        }

        .upload-box:hover .front-side {
            transform: rotateX(-40deg) skewX(15deg);
        }

        .folder .tip {
            background: linear-gradient(135deg, #ff9a56, #ff6f56);
            width: 70px;
            height: 15px;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: -10px;
            z-index: 2;
        }

        .folder .cover {
            background: linear-gradient(135deg, #ffe563, #ffc663);
            width: var(--folder-W);
            height: var(--folder-H);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .custom-file-upload {
            font-size: 1em;
            color: #ffffff;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: background var(--transition) ease;
            display: inline-block;
            width: 100%;
            padding: 10px 15px;
            position: relative;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .custom-file-upload:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .custom-file-upload input[type="file"] {
            display: none;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-15px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            width: 100%;
        }

        .image-item {
            position: relative;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .image-remove:hover {
            transform: scale(1.1);
            background: red;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 text-gray-700">

    <div class="w-full max-w-3xl bg-white/95 backdrop-blur-md rounded-2xl sm:rounded-3xl shadow-xl overflow-hidden border border-white/50 relative flex flex-col"
        style="height: 95vh;">

        <div
            class="px-4 py-3 bg-white border-b flex flex-col sm:flex-row justify-between items-center gap-3 shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto justify-center sm:justify-start">
                <div class="bg-blue-100 p-1.5 rounded-lg text-blue-600"><i
                        class="fa-solid fa-notes-medical text-lg"></i></div>
                <h1 class="text-base sm:text-lg font-bold text-gray-800 no-break">รายงานอุบัติการณ์ ME</h1>
            </div>
            <div class="bg-gray-100 p-1 rounded-full flex shadow-inner w-full sm:w-auto">
                <button onclick="switchTab('form')" id="tab-form"
                    class="flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all shadow bg-white text-blue-600 no-break text-center">บันทึก</button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold text-gray-500 hover:text-gray-700 transition-all no-break text-center">Dashboard</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto overflow-x-hidden p-0 relative bg-gray-50/30">

            <div id="view-form" class="p-3 sm:p-6 animate-fade-in max-w-2xl mx-auto pb-20">
                <div class="rounded-xl sm:rounded-2xl overflow-hidden shadow-sm border border-gray-100 bg-white">
                    <div
                        class="bg-gradient-to-r from-orange-300 to-orange-400 p-3 sm:p-4 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-full bg-white opacity-10 transform -skew-x-12"></div>
                        <h2 class="text-lg sm:text-xl font-bold text-white relative z-10 drop-shadow-sm no-break"
                            id="formTitle">บันทึกข้อมูล (ME)</h2>
                    </div>

                    <div class="p-4 sm:p-6">
                        <form id="meForm" onsubmit="handleFormSubmit(event)">
                            <input type="hidden" name="rowId" id="editRowId">

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-gray-600 mb-1.5">วันที่เกิดเหตุ</label>
                                    <input type="date" name="incidentDate" id="incidentDate" required
                                        class="w-full px-3 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">HN / AN
                                        ผู้ป่วย</label>
                                    <div class="relative flex items-center">
                                        <input type="text" id="hnInput" name="hn" placeholder="ระบุเลข HN หรือ AN"
                                            required inputmode="numeric"
                                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                            class="w-full pl-3 pr-10 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none">
                                        <button type="button" onclick="startScanner()"
                                            class="absolute right-0 top-0 h-full px-3 text-gray-400 hover:text-blue-600"><i
                                                class="fa-solid fa-qrcode text-lg"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-5">
                                <label class="block text-sm font-semibold text-gray-600 mb-1.5">ชื่อผู้รายงาน <span
                                        class="text-red-400">*</span></label>
                                <input type="text" name="reporter" id="reporter" placeholder="ระบุชื่อผู้รายงาน"
                                    required
                                    class="w-full px-3 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none">
                            </div>

                            <div class="mb-6">
                                <p class="text-center text-sm font-semibold text-gray-500 mb-3">
                                    เลือกประเภทความคลาดเคลื่อน</p>
                                <input type="hidden" name="meType" id="meType">
                                <div class="grid grid-cols-3 gap-2 sm:gap-4">
                                    <button type="button" onclick="selectType('แพ้ยาซ้ำ', 1, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-teal-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 h-20 sm:h-24 shadow-sm hover:bg-teal-50">
                                        <div
                                            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-teal-100 text-teal-500 flex items-center justify-center text-sm sm:text-lg group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-pills"></i></div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-teal-700 text-xs sm:text-sm no-break">แพ้ยาซ้ำ</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                    <button type="button" onclick="selectType('จ่ายยาผิดคน', 2, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-pink-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 h-20 sm:h-24 shadow-sm hover:bg-pink-50">
                                        <div
                                            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-sm sm:text-lg group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-user-xmark"></i></div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-pink-700 text-xs sm:text-sm no-break">ผิดคน</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                    <button type="button" onclick="selectType('ME ระดับ E ขึ้นไป', 3, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-orange-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 h-20 sm:h-24 shadow-sm hover:bg-orange-50">
                                        <div
                                            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-sm sm:text-lg group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-triangle-exclamation"></i></div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-orange-700 text-xs sm:text-sm no-break">ระดับ
                                            E+</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                </div>
                            </div>

                            <div id="detailSection"
                                class="hidden space-y-4 border-t border-dashed border-gray-200 pt-4 animate-fade-in">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">รายละเอียด <span
                                            class="text-red-400">*</span></label>
                                    <textarea name="meDetails" id="meDetails" rows="3" required
                                        class="w-full p-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none resize-none"
                                        placeholder="รายละเอียดเพิ่มเติม"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">ระดับความรุนแรง
                                        <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <select name="severity" id="severity" required
                                            class="w-full p-2.5 pl-3 pr-8 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none appearance-none">
                                            <option value="">-- เลือกระดับความรุนแรง --</option>
                                            <option value="A">【 A 】 มีโอกาสเกิด แต่ยังไม่เกิด</option>
                                            <option value="B">【 B 】 เกิดแล้ว แต่ไม่ถึงผู้ป่วย</option>
                                            <option value="C">【 C 】 ถึงผู้ป่วย แต่ไม่เป็นอันตราย</option>
                                            <option value="D">【 D 】 ถึงผู้ป่วย ต้องเฝ้าระวัง</option>
                                            <option value="E">【 E 】 เป็นอันตรายชั่วคราว/ต้องรักษา</option>
                                            <option value="F">【 F 】 ต้องนอน รพ./ยืดเวลานอน รพ.</option>
                                            <option value="G">【 G 】 เป็นอันตรายถาวร</option>
                                            <option value="H">【 H 】 ต้องกู้ชีพ/ช่วยชีวิต</option>
                                            <option value="I">【 I 】 เสียชีวิต</option>
                                        </select>
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                            <i class="fa-solid fa-chevron-down text-xs"></i></div>
                                    </div>
                                </div>

                                <div class="mt-4 flex flex-col items-center">
                                    <label
                                        class="block text-sm font-semibold text-gray-600 mb-2 w-full text-left">แนบรูปภาพประกอบ
                                        (Optional)</label>

                                    <div id="dropArea" class="upload-box">
                                        <div class="folder">
                                            <div class="front-side">
                                                <div class="tip"></div>
                                                <div class="cover"></div>
                                            </div>
                                            <div class="back-side cover"></div>
                                        </div>
                                        <label class="custom-file-upload">
                                            <input class="title" id="fileInput" type="file" accept="image/*" multiple
                                                onchange="handleFileSelect(this)" />
                                            <span id="dropText">Choose a file</span>
                                        </label>
                                    </div>

                                    <div id="imageGrid" class="image-grid w-full"></div>
                                </div>

                                <div class="flex gap-3 pt-6">
                                    <button type="button" onclick="resetForm()"
                                        class="flex-1 py-2.5 rounded-full border border-gray-300 text-gray-500 font-bold hover:bg-gray-50 transition-all text-sm">ยกเลิก</button>
                                    <button type="submit" id="submitBtn"
                                        class="flex-[2] py-2.5 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold shadow-md hover:shadow-blue-500/30 transition-all text-sm">บันทึก</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-400 mt-4">© 2025 Hospital Safety Report System</p>
            </div>

            <div id="view-dashboard" class="hidden p-3 sm:p-6 animate-fade-in flex flex-col pb-10">
                <div class="flex justify-between items-center mb-4 gap-2">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 no-break">สรุปภาพรวม</h3>
                        <p class="text-xs text-gray-500 no-break">ข้อมูลตามตัวกรองปัจจุบัน</p>
                    </div>
                    <button onclick="loadDashboardData()"
                        class="text-xs sm:text-sm bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-full shadow-sm text-blue-600 hover:bg-blue-100 font-bold transition-all flex items-center gap-1.5 active:scale-95 no-break"><i
                            class="fa-solid fa-rotate"></i> อัปเดต</button>
                </div>
                <div class="mb-4 sm:mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-0.5 shadow-md">
                        <div class="bg-white rounded-xl p-3 sm:p-4 flex items-center justify-between">
                            <div>
                                <p
                                    class="text-gray-500 text-[10px] sm:text-xs font-bold uppercase tracking-wider no-break">
                                    จำนวนรายงาน (ตามตัวกรอง)</p>
                                <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mt-1" id="totalCount">0
                                </h2>
                                <p class="text-xs text-gray-400">รายการ</p>
                            </div>
                            <div
                                class="bg-blue-100 w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center text-blue-600 text-lg sm:text-xl shadow-sm">
                                <i class="fa-solid fa-file-medical"></i></div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-xs sm:text-sm font-bold text-gray-600 mb-2 flex items-center gap-2"><span
                                class="w-2 h-4 sm:h-6 bg-teal-400 rounded-full"></span> สัดส่วนความเสี่ยง (%)</h4>
                        <div class="h-40 sm:h-48 relative flex justify-center"><canvas id="typeChart"></canvas></div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-xs sm:text-sm font-bold text-gray-600 mb-2 flex items-center gap-2"><span
                                class="w-2 h-4 sm:h-6 bg-red-400 rounded-full"></span> ระดับความรุนแรง</h4>
                        <div class="h-40 sm:h-48 relative"><canvas id="severityChart"></canvas></div>
                    </div>
                </div>
                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex-1 flex flex-col min-h-[400px]">
                    <div class="p-3 border-b bg-gray-50/50 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-gray-700 flex items-center gap-2 text-sm no-break"><i
                                    class="fa-solid fa-list-ul text-blue-500"></i> รายการบันทึก</h4><button
                                onclick="exportToExcel()"
                                class="bg-green-500 hover:bg-green-600 text-white text-[10px] sm:text-xs px-3 py-1 rounded-lg flex items-center gap-1 shadow active:scale-95 font-bold no-break"><i
                                    class="fa-solid fa-file-excel"></i> Export</button>
                        </div>
                        <div class="relative w-full"><i
                                class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i><input
                                type="text" id="searchInput" placeholder="ค้นหา..."
                                class="text-sm border border-gray-200 rounded-lg pl-8 pr-2 py-1.5 w-full focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none"
                                onkeyup="applyTableFilters()"></div>
                    </div>
                    <div class="p-2 grid grid-cols-2 gap-2 bg-white text-[10px] sm:text-xs border-b">
                        <div class="flex flex-col gap-0.5"><span class="text-gray-400 font-bold ml-1">เริ่ม</span><input
                                type="date" id="filterStartDate" class="border rounded-lg p-1 bg-gray-50 w-full text-xs"
                                onchange="applyTableFilters()"></div>
                        <div class="flex flex-col gap-0.5"><span class="text-gray-400 font-bold ml-1">ถึง</span><input
                                type="date" id="filterEndDate" class="border rounded-lg p-1 bg-gray-50 w-full text-xs"
                                onchange="applyTableFilters()"></div>
                        <div class="flex flex-col gap-0.5"><span
                                class="text-gray-400 font-bold ml-1">ประเภท</span><select id="filterType"
                                class="border rounded-lg p-1 bg-gray-50 w-full text-xs" onchange="applyTableFilters()">
                                <option value="">ทั้งหมด</option>
                                <option value="แพ้ยาซ้ำ">แพ้ยาซ้ำ</option>
                                <option value="จ่ายยาผิดคน">ผิดคน</option>
                                <option value="ME ระดับ E ขึ้นไป">ระดับ E+</option>
                            </select></div>
                        <div class="flex flex-col gap-0.5"><span
                                class="text-gray-400 font-bold ml-1">ความรุนแรง</span><select id="filterSeverity"
                                class="border rounded-lg p-1 bg-gray-50 w-full text-xs" onchange="applyTableFilters()">
                                <option value="">ทั้งหมด</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="H">H</option>
                                <option value="I">I</option>
                            </select></div>
                    </div>
                    <div class="overflow-auto flex-1 relative">
                        <table class="w-full text-xs sm:text-sm text-left text-gray-600">
                            <thead class="text-[10px] sm:text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-2 font-bold no-break">วันที่</th>
                                    <th class="px-3 py-2 font-bold no-break">HN / AN</th>
                                    <th class="px-3 py-2 font-bold no-break">ประเภท</th>
                                    <th class="px-3 py-2 font-bold no-break">รายละเอียด</th>
                                    <th class="px-3 py-2 font-bold no-break">ระดับ</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="bg-white divide-y divide-gray-100">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-400">รอการโหลดข้อมูล...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 bg-white border-t flex justify-between items-center text-xs text-gray-500 shrink-0">
                        <button onclick="changePage(-1)"
                            class="px-3 py-1 rounded border hover:bg-gray-50 disabled:opacity-50 no-break">«
                            ก่อนหน้า</button>
                        <span id="pageIndicator"
                            class="font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded no-break">1 / 1</span>
                        <button onclick="changePage(1)"
                            class="px-3 py-1 rounded border hover:bg-gray-50 disabled:opacity-50 no-break">ถัดไป
                            »</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailModal"
        class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex justify-center items-center z-[10000] transition-opacity duration-300 p-4">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-popup transform scale-100 transition-transform relative max-h-[90vh] flex flex-col">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold text-base sm:text-lg flex items-center gap-2"><i
                        class="fa-solid fa-circle-info text-white/80"></i> รายละเอียด</h3>
                <button onclick="closeModal()"
                    class="text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 overflow-y-auto">
                <div class="flex gap-3">
                    <div class="w-1/2 bg-gray-50 p-2 rounded-lg border border-gray-100"><label
                            class="block text-[10px] font-bold text-gray-400 uppercase mb-0.5 no-break">วันที่เกิดเหตุ</label>
                        <p id="modalDate" class="text-gray-800 font-bold text-sm sm:text-base no-break"></p>
                    </div>
                    <div class="w-1/2 bg-gray-50 p-2 rounded-lg border border-gray-100"><label
                            class="block text-[10px] font-bold text-gray-400 uppercase mb-0.5 no-break">HN / AN
                            ผู้ป่วย</label>
                        <p id="modalHN" class="text-gray-800 font-bold text-sm sm:text-base no-break"></p>
                    </div>
                </div>
                <div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">ผู้รายงาน</label>
                    <p id="modalReporter"
                        class="text-gray-800 font-bold text-sm bg-blue-50 p-2 rounded-lg border border-blue-100"></p>
                </div>
                <div><label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">ประเภทความคลาดเคลื่อน</label><span
                        id="modalType"
                        class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs sm:text-sm font-bold text-white shadow-sm transition-colors no-break"></span>
                </div>
                <div><label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">ระดับความรุนแรง</label>
                    <div class="bg-red-50 border-l-4 border-red-400 rounded-r-lg p-2.5">
                        <p id="modalSeverity" class="text-red-700 font-bold text-xs sm:text-sm"></p>
                    </div>
                </div>
                <div><label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">รายละเอียดเพิ่มเติม</label>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 max-h-32 overflow-y-auto text-xs sm:text-sm text-gray-600 leading-relaxed"
                        id="modalDetails"></div>
                </div>

                <div>
                    <label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">หลักฐานรูปภาพ</label>
                    <div id="modalGallery" class="flex overflow-x-auto gap-2 snap-x snap-mandatory pb-2 no-scrollbar"
                        style="-webkit-overflow-scrolling: touch;">
                    </div>
                </div>

            </div>
            <div class="p-3 bg-gray-50 border-t shrink-0 flex justify-between items-center">
                <div class="flex gap-2">
                    <button id="btnDelete"
                        class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-1 transition-colors"><i
                            class="fa-solid fa-trash-can"></i> ลบ</button>
                    <button id="btnEdit"
                        class="bg-yellow-100 text-yellow-700 hover:bg-yellow-200 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-1 transition-colors"><i
                            class="fa-solid fa-pen-to-square"></i> แก้ไข</button>
                </div>
                <button onclick="closeModal()"
                    class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-100">ปิด</button>
            </div>
        </div>
    </div>

    <div id="scannerModal"
        class="hidden fixed inset-0 bg-gray-900/90 backdrop-blur-sm flex justify-center items-center z-[10001] p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative flex flex-col">
            <div class="bg-gray-800 p-3 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center gap-2 text-sm"><i class="fa-solid fa-qrcode"></i> สแกน
                    HN / AN</h3><button onclick="stopScanner()"
                    class="text-gray-400 hover:text-white w-7 h-7 rounded-full flex items-center justify-center transition-colors"><i
                        class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div
                class="p-0 bg-black relative flex-1 min-h-[250px] flex items-center justify-center overflow-hidden bg-black">
                <div id="reader" class="w-full h-full bg-black"></div>
            </div>
        </div>
    </div>
    <div id="loading"
        class="hidden fixed inset-0 bg-white/80 backdrop-blur-md flex flex-col justify-center items-center z-[9999]">
        <div class="relative flex justify-center items-center mb-6">
            <div class="absolute animate-ping inline-flex h-16 w-16 rounded-full bg-blue-400 opacity-20"></div>
            <div class="relative animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-500"></div>
        </div>
        <p class="text-gray-600 font-bold text-base animate-pulse">กำลังประมวลผล...</p>
    </div>

    <script>
        // ✅ URL API (อัปเดตล่าสุด)
        const API_URL = "https://script.google.com/macros/s/AKfycbzcYcPJBww_z6jZhe65-V1_AWlgHEaLuVCkGnk6D4Omj1VU19ehCXfdvbck_j9WoRdw/exec";

        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        const rowsPerPage = 15;
        let isDashboardLoaded = false;
        let html5QrCode = null;
        let currentRecord = null;
        let uploadedFiles = [];

        document.addEventListener('DOMContentLoaded', () => {
            const dropArea = document.getElementById('dropArea');
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false));
                ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.querySelector('.upload-box').classList.add('drag-active'), false)); // แก้ class ให้ตรงกับ CSS ใหม่
                ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.querySelector('.upload-box').classList.remove('drag-active'), false));
                dropArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length) handleFiles(files);
                }, false);
            }
        });

        function handleFileSelect(input) {
            handleFiles(input.files);
            input.value = "";
        }

        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                if (files[i].size > 10 * 1024 * 1024) { Swal.fire('ไฟล์ใหญ่เกินไป', 'สูงสุด 10MB', 'warning'); continue; }
                uploadedFiles.push(files[i]);
            }
            updateDropText();
            renderPreviews();
        }

        function updateDropText() {
            const dropText = document.getElementById('dropText');
            if (uploadedFiles.length > 0) {
                dropText.innerHTML = `เพิ่มรูปภาพอีก... (${uploadedFiles.length})`;
            } else {
                dropText.innerHTML = "Choose a file";
            }
        }

        function renderPreviews() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = "";
            uploadedFiles.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'image-item';

                const img = document.createElement('img');
                if (typeof item === 'string') {
                    img.src = convertDriveLink(item);
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => img.src = e.target.result;
                    reader.readAsDataURL(item);
                }

                const removeBtn = document.createElement('div');
                removeBtn.className = 'image-remove';
                removeBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                removeBtn.onclick = () => {
                    uploadedFiles.splice(index, 1);
                    updateDropText();
                    renderPreviews();
                };

                div.appendChild(img);
                div.appendChild(removeBtn);
                grid.appendChild(div);
            });
        }

        function convertDriveLink(url) {
            if (!url) return "";
            if (url.includes("id=")) return `https://drive.google.com/thumbnail?id=${url.split('id=')[1].split('&')[0]}&sz=w1000`;
            if (url.includes("/d/")) return `https://drive.google.com/thumbnail?id=${url.split('/d/')[1].split('/')[0]}&sz=w1000`;
            return url;
        }

        function switchTab(tabName) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-form').className = "flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold text-gray-500 hover:text-gray-700 transition-all no-break text-center";
            document.getElementById('tab-dashboard').className = "flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold text-gray-500 hover:text-gray-700 transition-all no-break text-center";
            document.getElementById('tab-' + tabName).className = "flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all shadow bg-white text-blue-600 no-break text-center";
            document.getElementById('view-' + tabName).classList.remove('hidden');
            if (tabName === 'dashboard' && !isDashboardLoaded) { loadDashboardData(); isDashboardLoaded = true; }
            else if (tabName === 'dashboard' && isDashboardLoaded) { setTimeout(() => { if (myTypeChart) myTypeChart.resize(); if (mySevChart) mySevChart.resize(); }, 100); }
        }

        document.querySelector('input[type="date"]').valueAsDate = new Date();
        loadDashboardData();
        isDashboardLoaded = true;

        function selectType(typeName, typeId, btn) {
            document.getElementById('meType').value = typeName;
            document.querySelectorAll('.btn-type').forEach(b => {
                b.classList.remove('selected', 'border-teal-400', 'bg-teal-50', 'border-pink-400', 'bg-pink-50', 'border-orange-400', 'bg-orange-50');
                b.classList.add('bg-white', 'border-gray-100');
            });
            btn.classList.remove('bg-white', 'border-gray-100');
            btn.classList.add('selected');
            if (typeId === 1) btn.classList.add('border-teal-400', 'bg-teal-50');
            else if (typeId === 2) btn.classList.add('border-pink-400', 'bg-pink-50');
            else if (typeId === 3) btn.classList.add('border-orange-400', 'bg-orange-50');
            document.getElementById('detailSection').classList.remove('hidden');
            if (!document.getElementById('editRowId').value) document.getElementById('meDetails').focus();
        }

        function resetForm() {
            document.getElementById('meForm').reset();
            document.getElementById('detailSection').classList.add('hidden');
            document.querySelector('input[type="date"]').valueAsDate = new Date();
            document.querySelectorAll('.btn-type').forEach(b => {
                b.classList.remove('selected', 'border-teal-400', 'bg-teal-50', 'border-pink-400', 'bg-pink-50', 'border-orange-400', 'bg-orange-50');
                b.classList.add('bg-white', 'border-gray-100');
            });
            uploadedFiles = [];
            renderPreviews();
            updateDropText();

            document.getElementById('editRowId').value = "";
            document.getElementById('formTitle').innerText = "บันทึกข้อมูล (ME)";
            document.getElementById('submitBtn').innerText = "บันทึก";
            document.getElementById('submitBtn').className = "flex-[2] py-2.5 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold shadow-md hover:shadow-blue-500/30 hover:-translate-y-0.5 transition-all active:scale-95 text-sm";
        }

        async function prepareImagesForSubmit() {
            const processedImages = [];
            for (const item of uploadedFiles) {
                if (typeof item === 'string') {
                    processedImages.push({ url: item });
                } else {
                    const base64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                        reader.readAsDataURL(item);
                    });
                    processedImages.push({ data: base64, mime: item.type });
                }
            }
            return processedImages;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const meType = document.getElementById('meType').value;
            const severity = document.getElementById('severity').value;
            if (!meType) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกประเภทความคลาดเคลื่อน', 'warning'); return; }
            if (!severity) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกระดับความรุนแรง', 'warning'); return; }

            document.getElementById('loading').classList.remove('hidden');

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.action = data.rowId ? 'update' : 'save';
            data.images = await prepareImagesForSubmit();

            fetch(API_URL, { method: "POST", body: JSON.stringify(data), headers: { "Content-Type": "text/plain" } })
                .then(response => response.json())
                .then(result => {
                    document.getElementById('loading').classList.add('hidden');
                    if (result.status === 'success') {
                        const msg = data.action === 'update' ? 'แก้ไขข้อมูลสำเร็จ' : 'บันทึกสำเร็จ';
                        Swal.fire({ icon: 'success', title: msg, timer: 1500, showConfirmButton: false }).then(() => {
                            resetForm();
                            if (data.action === 'update') switchTab('dashboard');
                            loadDashboardData();
                        });
                    } else {
                        Swal.fire('Error', 'ไม่สำเร็จ: ' + (result.message || ""), 'error');
                    }
                })
                .catch(error => {
                    document.getElementById('loading').classList.add('hidden');
                    Swal.fire('Error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ', 'error');
                });
        }

        async function verifyPin() {
            const { value: pin } = await Swal.fire({
                title: 'ยืนยันรหัสผ่าน',
                input: 'password',
                inputPlaceholder: 'กรอกรหัส PIN',
                inputAttributes: { maxlength: 4, autocapitalize: 'off', autocorrect: 'off' },
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            });
            return pin === "1234";
        }

        async function editRecord() {
            closeModal();
            if (await verifyPin()) {
                const item = currentRecord;
                if (!item) return;

                document.getElementById('editRowId').value = item.rowId;
                document.querySelector('input[name="incidentDate"]').value = item.date.split("T")[0];
                document.getElementById('hnInput').value = item.hn;
                document.getElementById('reporter').value = item.reporter;
                document.getElementById('meDetails').value = item.details;
                document.getElementById('severity').value = item.severity.split(" ")[0];

                const types = { 'แพ้ยาซ้ำ': 1, 'จ่ายยาผิดคน': 2, 'ME ระดับ E ขึ้นไป': 3 };
                const typeId = types[item.meType] || 0;
                if (typeId) {
                    const btns = document.querySelectorAll('.btn-type');
                    selectType(item.meType, typeId, btns[typeId - 1]);
                }

                uploadedFiles = [];
                if (item.imageUrl && item.imageUrl !== "-" && item.imageUrl.trim() !== "") {
                    uploadedFiles = item.imageUrl.split(',');
                }
                renderPreviews();
                updateDropText();

                document.getElementById('formTitle').innerText = "แก้ไขข้อมูล";
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.innerText = "อัปเดตข้อมูล";
                submitBtn.className = "flex-[2] py-2.5 rounded-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold shadow-md hover:shadow-yellow-500/30 hover:-translate-y-0.5 transition-all active:scale-95 text-sm";

                switchTab('form');
            } else {
                Swal.fire('รหัสผ่านผิด', 'คุณไม่มีสิทธิ์แก้ไขข้อมูล', 'error');
            }
        }

        async function deleteRecord() {
            if (await verifyPin()) {
                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    text: "ข้อมูลจะถูกลบถาวร!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ลบข้อมูล'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('loading').classList.remove('hidden');
                        fetch(API_URL, {
                            method: "POST",
                            body: JSON.stringify({ action: 'delete', rowId: currentRecord.rowId }),
                            headers: { "Content-Type": "text/plain" }
                        })
                            .then(response => response.json())
                            .then(res => {
                                document.getElementById('loading').classList.add('hidden');
                                if (res.status === 'success') {
                                    Swal.fire('ลบสำเร็จ!', '', 'success');
                                    closeModal();
                                    loadDashboardData();
                                } else {
                                    Swal.fire('Error', 'ลบไม่สำเร็จ', 'error');
                                }
                            });
                    }
                });
            } else {
                Swal.fire('รหัสผ่านผิด', 'คุณไม่มีสิทธิ์ลบข้อมูล', 'error');
            }
        }

        function startScanner() { document.getElementById('scannerModal').classList.remove('hidden'); setTimeout(() => { if (html5QrCode === null) { html5QrCode = new Html5Qrcode("reader"); } const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0 }; html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure).catch(err => { Swal.fire('Error', 'ไม่สามารถเปิดกล้องได้', 'error'); stopScanner(); }); }, 100); }
        function onScanSuccess(decodedText, decodedResult) { document.getElementById('hnInput').value = decodedText; stopScanner(); const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true }); Toast.fire({ icon: 'success', title: 'อ่านรหัสสำเร็จ: ' + decodedText }); }
        function onScanFailure(error) { }
        function stopScanner() { document.getElementById('scannerModal').classList.add('hidden'); if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => console.log(err)); } }

        function loadDashboardData() {
            document.getElementById('loading').classList.remove('hidden');
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getRecords' }), headers: { "Content-Type": "text/plain" } })
                .then(response => response.json())
                .then(result => {
                    allRecords = result.data || [];
                    applyTableFilters();
                    document.getElementById('loading').classList.add('hidden');
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true });
                    Toast.fire({ icon: 'success', title: 'ข้อมูลล่าสุด' });
                })
                .catch(err => { console.error(err); document.getElementById('loading').classList.add('hidden'); });
        }

        // ✅ เพิ่มฟังก์ชัน Filter ที่ขาดหายไป
        function applyTableFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;
            const sev = document.getElementById('filterSeverity').value;

            filteredRecords = allRecords.filter(item => {
                const matchSearch = (item.hn || "").toLowerCase().includes(search) || (item.details || "").toLowerCase().includes(search);
                const matchType = type ? item.meType === type : true;
                const matchSev = sev ? item.severity.startsWith(sev) : true;
                const date = item.date.split("T")[0];
                const matchStart = start ? date >= start : true;
                const matchEnd = end ? date <= end : true;
                return matchSearch && matchType && matchSev && matchStart && matchEnd;
            });

            currentPage = 1;
            renderTable();
            updateDashboardStats(filteredRecords);
        }

        // ✅ เพิ่มฟังก์ชัน Render Table ที่ขาดหายไป
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredRecords.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-400">ไม่พบข้อมูล</td></tr>`;
                document.getElementById('pageIndicator').innerText = "0 / 0";
                return;
            }

            pageData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50/50 transition-colors border-b border-gray-50 cursor-pointer";
                tr.onclick = () => openRecordModal(start + index);

                let badgeColor = "bg-gray-400";
                if (item.meType.includes("แพ้")) badgeColor = "bg-teal-500";
                else if (item.meType.includes("ผิดคน")) badgeColor = "bg-pink-500";
                else badgeColor = "bg-orange-500";

                tr.innerHTML = `
            <td class="px-3 py-3 font-medium text-gray-600 no-break">${formatDate(item.date)}</td>
            <td class="px-3 py-3 text-blue-600 font-bold no-break">${item.hn}</td>
            <td class="px-3 py-3"><span class="${badgeColor} text-white px-2 py-0.5 rounded text-[10px] sm:text-xs no-break">${item.meType}</span></td>
            <td class="px-3 py-3 text-gray-500 truncate max-w-[100px] sm:max-w-[150px]">${item.details}</td>
            <td class="px-3 py-3 font-bold text-red-500 text-center">${item.severity.split(' ')[0]}</td>
        `;
                tbody.appendChild(tr);
            });

            const totalPages = Math.ceil(filteredRecords.length / rowsPerPage);
            document.getElementById('pageIndicator').innerText = `${currentPage} / ${totalPages}`;
        }

        function updateDashboardStats(records) { document.getElementById('totalCount').textContent = records.length; const typeCounts = {}; const nameMapping = { 'แพ้ยาซ้ำ': 'แพ้ยาซ้ำ', 'จ่ายยาผิดคน': 'ผิดคน', 'ME ระดับ E ขึ้นไป': 'ระดับ E+' }; records.forEach(r => { const rawType = r.meType; const shortName = nameMapping[rawType] || rawType; typeCounts[shortName] = (typeCounts[shortName] || 0) + 1; }); const severityCounts = {}; records.forEach(r => { const sev = (r.severity || "").split(' ')[0]; if (sev) severityCounts[sev] = (severityCounts[sev] || 0) + 1; }); const sortedSevKeys = Object.keys(severityCounts).sort(); const sortedSevCounts = {}; sortedSevKeys.forEach(k => sortedSevCounts[k] = severityCounts[k]); renderCharts({ typeCounts: typeCounts, severityCounts: sortedSevCounts, total: records.length }); }
        let myTypeChart, mySevChart;
        function renderCharts(data) { const typeLabels = Object.keys(data.typeCounts).map(label => { const value = data.typeCounts[label]; const percent = data.total > 0 ? ((value / data.total) * 100).toFixed(1) : 0; return `${label} (${percent}%)`; }); const ctxType = document.getElementById('typeChart').getContext('2d'); if (myTypeChart) myTypeChart.destroy(); myTypeChart = new Chart(ctxType, { type: 'doughnut', data: { labels: typeLabels, datasets: [{ data: Object.values(data.typeCounts), backgroundColor: ['#2dd4bf', '#f472b6', '#fb923c', '#818cf8', '#94a3b8'], borderColor: '#ffffff', borderWidth: 3, hoverOffset: 15, hoverBorderColor: '#ffffff', hoverBorderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { usePointStyle: true, padding: 15, font: { family: 'Sarabun', size: 11 } } }, tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1, padding: 10, boxPadding: 4, usePointStyle: true, callbacks: { label: function (context) { return ' ' + context.raw + ' รายการ'; } } } }, animation: { animateScale: true, animateRotate: true } } }); const ctxSev = document.getElementById('severityChart').getContext('2d'); const gradientBlue = ctxSev.createLinearGradient(0, 0, 0, 400); gradientBlue.addColorStop(0, 'rgba(59, 130, 246, 1)'); gradientBlue.addColorStop(1, 'rgba(147, 197, 253, 0.3)'); const gradientRed = ctxSev.createLinearGradient(0, 0, 0, 400); gradientRed.addColorStop(0, 'rgba(239, 68, 68, 1)'); gradientRed.addColorStop(1, 'rgba(252, 165, 165, 0.3)'); if (mySevChart) mySevChart.destroy(); const sevLabels = Object.keys(data.severityCounts); const sevData = Object.values(data.severityCounts); const backgroundColors = sevLabels.map(label => { return ['E', 'F', 'G', 'H', 'I'].some(l => label.startsWith(l)) ? gradientRed : gradientBlue; }); mySevChart = new Chart(ctxSev, { type: 'bar', data: { labels: sevLabels, datasets: [{ label: 'จำนวน', data: sevData, backgroundColor: backgroundColors, borderColor: 'transparent', borderWidth: 0, borderRadius: 6, barPercentage: 0.6, categoryPercentage: 0.8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1, padding: 10, displayColors: false, callbacks: { title: function (context) { return 'ระดับความรุนแรง: ' + context[0].label; }, label: function (context) { let value = context.raw; let total = data.total; let percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; return ' ' + value + ' รายการ (' + percentage + '%)'; } } } }, scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6', borderDash: [4, 4] }, ticks: { font: { family: 'Sarabun', size: 10 }, stepSize: 1 } }, x: { grid: { display: false }, ticks: { font: { family: 'Sarabun', size: 10 } } } } } }); }

        // ✅ อัปเดต openRecordModal ให้เป็น Horizontal Scroll Gallery
        function openRecordModal(index) {
            const item = filteredRecords[index];
            if (!item) return;
            currentRecord = item;

            document.getElementById('modalDate').textContent = formatDate(item.date);
            document.getElementById('modalHN').textContent = item.hn;
            document.getElementById('modalReporter').textContent = item.reporter || "-";
            const typeSpan = document.getElementById('modalType');
            typeSpan.textContent = item.meType;
            typeSpan.className = "inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs sm:text-sm font-bold text-white shadow-md no-break";
            if (item.meType.includes('แพ้')) typeSpan.classList.add('bg-teal-500');
            else if (item.meType.includes('ผิดคน')) typeSpan.classList.add('bg-pink-500');
            else typeSpan.classList.add('bg-orange-500');
            document.getElementById('modalSeverity').textContent = item.severity;
            document.getElementById('modalDetails').textContent = item.details || "-";

            const gallery = document.getElementById('modalGallery');
            gallery.innerHTML = "";
            gallery.className = "hidden";

            if (item.imageUrl && item.imageUrl !== "-" && item.imageUrl.trim() !== "") {
                gallery.classList.remove('hidden');
                gallery.className = "flex overflow-x-auto gap-2 snap-x snap-mandatory pb-2 no-scrollbar";

                const urls = item.imageUrl.split(',');
                urls.forEach(url => {
                    const thumbUrl = convertDriveLink(url);
                    const img = document.createElement('img');
                    img.src = thumbUrl;
                    img.className = "w-full h-48 object-contain bg-black/5 rounded-lg flex-shrink-0 snap-center border border-gray-200 cursor-pointer";
                    img.onclick = () => window.open(url, '_blank');
                    gallery.appendChild(img);
                });
            } else {
                gallery.classList.remove('hidden');
                gallery.innerHTML = `<div class="w-full text-center text-gray-400 py-4 text-xs">ไม่มีรูปภาพประกอบ</div>`;
            }

            document.getElementById('btnEdit').onclick = editRecord;
            document.getElementById('btnDelete').onclick = deleteRecord;
            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
        function changePage(d) { const total = Math.ceil(filteredRecords.length / rowsPerPage); if ((d === -1 && currentPage > 1) || (d === 1 && currentPage < total)) { currentPage += d; renderTable(); } }
        function formatDate(d) { if (!d) return "-"; return new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function exportToExcel() {
            if (filteredRecords.length === 0) { Swal.fire('แจ้งเตือน', 'ไม่มีข้อมูลให้ Export', 'info'); return; }
            let csv = "data:text/csv;charset=utf-8,\uFEFFTimestamp,Date,HN,Type,Details,Severity,Reporter,ImageURL\n";
            filteredRecords.forEach(r => { csv += `${r.timestamp},${r.date},${r.hn},${r.meType},${(r.details || "").replace(/,/g, " ")},${(r.severity || "").split(' ')[0]},${r.reporter || "-"},${r.imageUrl || "-"}\n`; });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "ME_Report.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes scan { 0%, 100% { top: 0; } 50% { top: 100%; } }`;
        document.head.appendChild(styleSheet);
    </script>
</body>

</html>
