<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå ME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            blue: '#4A90E2',
                            light: '#F0F4F8',
                        }
                    },
                    screens: {
                        'xs': '375px',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            overscroll-behavior-y: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .btn-type {
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: visible;
        }

        .btn-type:active {
            transform: scale(0.95);
        }

        .checkmark {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10B981;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            z-index: 20;
        }

        .btn-type.selected .checkmark {
            opacity: 1;
            transform: scale(1);
        }

        .btn-type.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px -3px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #reader video {
            object-fit: cover;
            border-radius: 10px;
            width: 100% !important;
            height: 100% !important;
        }

        .no-break {
            whitespace: nowrap;
        }

        /* ‚úÖ Spinner CSS */
        .spinner {
            font-size: 28px;
            position: relative;
            display: inline-block;
            width: 1em;
            height: 1em;
        }

        .spinner.center {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            z-index: 5;
        }

        .spinner .spinner-blade {
            position: absolute;
            left: 0.4629em;
            bottom: 0;
            width: 0.074em;
            height: 0.2777em;
            border-radius: 0.0555em;
            background-color: transparent;
            transform-origin: center -0.2222em;
            animation: spinner-fade9234 1s infinite linear;
        }

        .spinner .spinner-blade:nth-child(1) { animation-delay: 0s; transform: rotate(0deg); }
        .spinner .spinner-blade:nth-child(2) { animation-delay: 0.083s; transform: rotate(30deg); }
        .spinner .spinner-blade:nth-child(3) { animation-delay: 0.166s; transform: rotate(60deg); }
        .spinner .spinner-blade:nth-child(4) { animation-delay: 0.249s; transform: rotate(90deg); }
        .spinner .spinner-blade:nth-child(5) { animation-delay: 0.332s; transform: rotate(120deg); }
        .spinner .spinner-blade:nth-child(6) { animation-delay: 0.415s; transform: rotate(150deg); }
        .spinner .spinner-blade:nth-child(7) { animation-delay: 0.498s; transform: rotate(180deg); }
        .spinner .spinner-blade:nth-child(8) { animation-delay: 0.581s; transform: rotate(210deg); }
        .spinner .spinner-blade:nth-child(9) { animation-delay: 0.664s; transform: rotate(240deg); }
        .spinner .spinner-blade:nth-child(10) { animation-delay: 0.747s; transform: rotate(270deg); }
        .spinner .spinner-blade:nth-child(11) { animation-delay: 0.83s; transform: rotate(300deg); }
        .spinner .spinner-blade:nth-child(12) { animation-delay: 0.913s; transform: rotate(330deg); }

        @keyframes spinner-fade9234 {
            0% { background-color: #69717d; }
            100% { background-color: transparent; }
        }
        
        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }

        /* ‚úÖ New File Upload CSS (By Cksunandh) - Adjusted for Layout */
        .file-upload-container {
            width: 100%; /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 100% ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏° */
            max-width: 100%;
            margin-bottom: 10px;
        }

        .file-upload {
            position: relative;
            border: 2px dashed #b8bcbf;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            background-color: rgb(255, 255, 255);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }

        .file-upload:hover, .file-upload.dragover {
            background-color: #eef2ff;
            border-color: #4A90E2;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .upload-icon {
            font-size: 40px;
            color: #4A90E2;
            margin-bottom: 10px;
            font-style: normal;
        }

        .file-upload p {
            margin: 0;
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 text-gray-700">

    <div class="w-full max-w-3xl bg-white/95 backdrop-blur-md rounded-2xl sm:rounded-3xl shadow-xl overflow-hidden border border-white/50 relative flex flex-col"
        style="height: 95vh;">

        <div
            class="px-4 py-3 bg-white border-b flex flex-col sm:flex-row justify-between items-center gap-3 shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-2 sm:gap-3 w-full sm:w-auto justify-center sm:justify-start">
                <div class="bg-blue-100 p-1.5 rounded-lg text-blue-600">
                    <i class="fa-solid fa-notes-medical text-lg"></i>
                </div>
                <h1 class="text-base sm:text-lg font-bold text-gray-800 no-break">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ì‡πå ME</h1>
            </div>
            <div class="bg-gray-100 p-1 rounded-full flex shadow-inner w-full sm:w-auto">
                <button onclick="switchTab('form')" id="tab-form"
                    class="flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all shadow bg-white text-blue-600 no-break text-center">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold text-gray-500 hover:text-gray-700 transition-all no-break text-center">
                    Dashboard
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto overflow-x-hidden p-0 relative bg-gray-50/30">

            <div id="view-form" class="p-3 sm:p-6 animate-fade-in max-w-2xl mx-auto pb-20">

                <div class="rounded-xl sm:rounded-2xl overflow-hidden shadow-sm border border-gray-100 bg-white">
                    <div
                        class="bg-gradient-to-r from-orange-300 to-orange-400 p-3 sm:p-4 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-full bg-white opacity-10 transform -skew-x-12"></div>
                        <h2 class="text-lg sm:text-xl font-bold text-white relative z-10 drop-shadow-sm no-break">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (ME)</h2>
                    </div>

                    <div class="p-4 sm:p-6">
                        <form id="meForm" onsubmit="handleFormSubmit(event)">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-5">
                                <div>
                                    <label
                                        class="block text-sm font-semibold text-gray-600 mb-1.5">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fa-regular fa-calendar text-gray-400"></i>
                                        </div>
                                        <input type="date" name="incidentDate" required
                                            class="w-full pl-9 pr-3 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all outline-none text-base text-gray-700">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">HN / AN ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                                    <div class="relative flex items-center">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fa-regular fa-id-card text-gray-400"></i>
                                        </div>
                                        <input type="text" id="hnInput" name="hn" 
                                            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç HN ‡∏´‡∏£‡∏∑‡∏≠ AN" 
                                            required
                                            inputmode="numeric" 
                                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                            class="w-full pl-9 pr-10 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all outline-none text-base text-gray-700">
                                        
                                        <button type="button" onclick="startScanner()"
                                            class="absolute right-0 top-0 h-full px-3 text-gray-400 hover:text-blue-600 transition-colors active:scale-90"
                                            title="‡∏™‡πÅ‡∏Å‡∏ô">
                                            <i class="fa-solid fa-qrcode text-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-5">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô <span
                                            class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <div
                                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fa-solid fa-user-nurse text-gray-400"></i>
                                        </div>
                                        <input type="text" name="reporter" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô" required
                                            class="w-full pl-9 pr-4 py-2.5 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all outline-none text-base text-gray-700">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <p class="text-center text-sm font-semibold text-gray-500 mb-3">
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô</p>
                                <input type="hidden" name="meType" id="meType">
                                <div class="grid grid-cols-3 gap-2 sm:gap-4">
                                    <button type="button" onclick="selectType('‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥', 1, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-teal-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 h-20 sm:h-24 shadow-sm hover:bg-teal-50">
                                        <div
                                            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-teal-100 text-teal-500 flex items-center justify-center text-sm sm:text-lg group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-pills"></i>
                                        </div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-teal-700 text-xs sm:text-sm no-break">‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                    <button type="button" onclick="selectType('‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô', 2, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-pink-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 h-20 sm:h-24 shadow-sm hover:bg-pink-50">
                                        <div
                                            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-sm sm:text-lg group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-user-xmark"></i>
                                        </div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-pink-700 text-xs sm:text-sm no-break">‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                    <button type="button" onclick="selectType('ME ‡∏£‡∏∞‡∏î‡∏±‡∏ö E ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', 3, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-orange-200 rounded-xl p-2 flex flex-col items-center justify-center gap-1 h-20 sm:h-24 shadow-sm hover:bg-orange-50">
                                        <div
                                            class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-sm sm:text-lg group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-triangle-exclamation"></i>
                                        </div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-orange-700 text-xs sm:text-sm no-break">‡∏£‡∏∞‡∏î‡∏±‡∏ö
                                            E+</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                </div>
                            </div>

                            <div id="detailSection"
                                class="hidden space-y-4 border-t border-dashed border-gray-200 pt-4 animate-fade-in">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î <span
                                            class="text-red-400">*</span></label>
                                    <textarea name="meDetails" id="meDetails" rows="3" required
                                        class="w-full p-3 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all outline-none text-base text-gray-700 resize-none shadow-sm"
                                        placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-600 mb-1.5">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
                                        <span class="text-red-400">*</span></label>
                                    <div class="relative">
                                        <select name="severity" id="severity" required
                                            class="w-full p-2.5 pl-3 pr-8 rounded-lg bg-gray-50 border border-gray-200 focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition-all outline-none text-base font-medium text-gray-700 appearance-none shadow-sm cursor-pointer truncate">
                                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á --</option>
                                            <option value="A">„Äê A „Äë ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î</option>
                                            <option value="B">„Äê B „Äë ‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</option>
                                            <option value="C">„Äê C „Äë ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</option>
                                            <option value="D">„Äê D „Äë ‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á</option>
                                            <option value="E">„Äê E „Äë ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß/‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</option>
                                            <option value="F">„Äê F „Äë ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô ‡∏£‡∏û./‡∏¢‡∏∑‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≠‡∏ô ‡∏£‡∏û.</option>
                                            <option value="G">„Äê G „Äë ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£</option>
                                            <option value="H">„Äê H „Äë ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û/‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
                                            <option value="I">„Äê I „Äë ‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï</option>
                                        </select>
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                            <i class="fa-solid fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4 flex flex-col items-center">
                                    <label class="block text-sm font-semibold text-gray-600 mb-2 w-full text-left">
                                        ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (Optional)
                                    </label>
                                    
                                    <div id="dropArea" class="file-upload-container">
                                        <div class="file-upload">
                                            <input class="file-input" id="fileInput" type="file" accept="image/*" onchange="previewImage(this)" />
                                            <label class="file-label" for="fileInput">
                                                <i class="upload-icon">üìÅ</i>
                                                <p>Drag & Drop your files here<br>or click to upload</p>
                                            </label>
                                        </div>
                                    </div>

                                    <div id="previewContainer" class="hidden relative w-full max-w-[250px] h-[160px] bg-gray-100 rounded-xl border-2 border-dashed border-blue-300 flex justify-center items-center overflow-hidden mt-2">
                                        <img id="imgPreview" class="h-full object-contain" />
                                        <button type="button" onclick="removeImage()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-red-600 transition-all hover:scale-110">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex gap-3 pt-6">
                                    <button type="button" onclick="resetForm()"
                                        class="flex-1 py-2.5 rounded-full border border-gray-300 text-gray-500 font-bold hover:bg-gray-50 hover:text-gray-700 transition-all text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button type="submit"
                                        class="flex-[2] py-2.5 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold shadow-md hover:shadow-blue-500/30 hover:-translate-y-0.5 transition-all active:scale-95 text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-400 mt-4">¬© 2025 Hospital Safety Report System</p>
            </div>

            <div id="view-dashboard" class="hidden p-3 sm:p-6 animate-fade-in flex flex-col pb-10">

                <div class="flex justify-between items-center mb-4 gap-2">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 no-break">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
                        <p class="text-xs text-gray-500 no-break">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                    </div>
                    <button onclick="loadDashboardData()"
                        class="text-xs sm:text-sm bg-blue-50 border border-blue-100 px-3 py-1.5 rounded-full shadow-sm text-blue-600 hover:bg-blue-100 font-bold transition-all flex items-center gap-1.5 active:scale-95 no-break">
                        <i class="fa-solid fa-rotate"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                    </button>
                </div>

                <div class="mb-4 sm:mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-0.5 shadow-md">
                        <div class="bg-white rounded-xl p-3 sm:p-4 flex items-center justify-between">
                            <div>
                                <p
                                    class="text-gray-500 text-[10px] sm:text-xs font-bold uppercase tracking-wider no-break">
                                    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)</p>
                                <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mt-1" id="totalCount">0
                                </h2>
                                <p class="text-xs text-gray-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                            </div>
                            <div
                                class="bg-blue-100 w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center text-blue-600 text-lg sm:text-xl shadow-sm">
                                <i class="fa-solid fa-file-medical"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-xs sm:text-sm font-bold text-gray-600 mb-2 flex items-center gap-2">
                            <span class="w-2 h-4 sm:h-6 bg-teal-400 rounded-full"></span> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (%)
                        </h4>
                        <div class="h-40 sm:h-48 relative flex justify-center">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="text-xs sm:text-sm font-bold text-gray-600 mb-2 flex items-center gap-2">
                            <span class="w-2 h-4 sm:h-6 bg-red-400 rounded-full"></span> ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á
                        </h4>
                        <div class="h-40 sm:h-48 relative">
                            <canvas id="severityChart"></canvas>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex-1 flex flex-col min-h-[400px]">
                    <div class="p-3 border-b bg-gray-50/50 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-gray-700 flex items-center gap-2 text-sm no-break">
                                <i class="fa-solid fa-list-ul text-blue-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            </h4>
                            <button onclick="exportToExcel()"
                                class="bg-green-500 hover:bg-green-600 text-white text-[10px] sm:text-xs px-3 py-1 rounded-lg flex items-center gap-1 shadow active:scale-95 font-bold no-break">
                                <i class="fa-solid fa-file-excel"></i> Export
                            </button>
                        </div>
                        <div class="relative w-full">
                            <i
                                class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                                class="text-sm border border-gray-200 rounded-lg pl-8 pr-2 py-1.5 w-full focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none"
                                onkeyup="applyTableFilters()">
                        </div>
                    </div>

                    <div class="p-2 grid grid-cols-2 gap-2 bg-white text-[10px] sm:text-xs border-b">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-gray-400 font-bold ml-1">‡πÄ‡∏£‡∏¥‡πà‡∏°</span>
                            <input type="date" id="filterStartDate"
                                class="border rounded-lg p-1 bg-gray-50 w-full text-xs" onchange="applyTableFilters()">
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <span class="text-gray-400 font-bold ml-1">‡∏ñ‡∏∂‡∏á</span>
                            <input type="date" id="filterEndDate"
                                class="border rounded-lg p-1 bg-gray-50 w-full text-xs" onchange="applyTableFilters()">
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <span class="text-gray-400 font-bold ml-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span>
                            <select id="filterType" class="border rounded-lg p-1 bg-gray-50 w-full text-xs"
                                onchange="applyTableFilters()">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥">‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥</option>
                                <option value="‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô">‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô</option>
                                <option value="ME ‡∏£‡∏∞‡∏î‡∏±‡∏ö E ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ">‡∏£‡∏∞‡∏î‡∏±‡∏ö E+</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <span class="text-gray-400 font-bold ml-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</span>
                            <select id="filterSeverity" class="border rounded-lg p-1 bg-gray-50 w-full text-xs"
                                onchange="applyTableFilters()">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="H">H</option>
                                <option value="I">I</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-auto flex-1 relative">
                        <table class="w-full text-xs sm:text-sm text-left text-gray-600">
                            <thead class="text-[10px] sm:text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-3 py-2 font-bold no-break">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-3 py-2 font-bold no-break">HN / AN</th>
                                    <th class="px-3 py-2 font-bold no-break">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                    <th class="px-3 py-2 font-bold no-break">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                    <th class="px-3 py-2 font-bold no-break">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="bg-white divide-y divide-gray-100">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-400">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="p-2 bg-white border-t flex justify-between items-center text-xs text-gray-500 shrink-0">
                        <button onclick="changePage(-1)"
                            class="px-3 py-1 rounded border hover:bg-gray-50 disabled:opacity-50 no-break">¬´
                            ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                        <span id="pageIndicator"
                            class="font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded no-break">1 / 1</span>
                        <button onclick="changePage(1)"
                            class="px-3 py-1 rounded border hover:bg-gray-50 disabled:opacity-50 no-break">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                            ¬ª</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="detailModal"
        class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex justify-center items-center z-[10000] transition-opacity duration-300 p-4">
        <div
            class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-popup transform scale-100 transition-transform relative max-h-[90vh] flex flex-col">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold text-base sm:text-lg flex items-center gap-2">
                    <i class="fa-solid fa-circle-info text-white/80"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                </h3>
                <button onclick="closeModal()"
                    class="text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 overflow-y-auto">
                <div class="flex gap-3">
                    <div class="w-1/2 bg-gray-50 p-2 rounded-lg border border-gray-100">
                        <label
                            class="block text-[10px] font-bold text-gray-400 uppercase mb-0.5 no-break">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <p id="modalDate" class="text-gray-800 font-bold text-sm sm:text-base no-break"></p>
                    </div>
                    <div class="w-1/2 bg-gray-50 p-2 rounded-lg border border-gray-100">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-0.5 no-break">HN / AN
                            ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                        <p id="modalHN" class="text-gray-800 font-bold text-sm sm:text-base no-break"></p>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">‡∏ú‡∏π‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <p id="modalReporter"
                        class="text-gray-800 font-bold text-sm bg-blue-50 p-2 rounded-lg border border-blue-100"></p>
                </div>

                <div>
                    <label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô</label>
                    <span id="modalType"
                        class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs sm:text-sm font-bold text-white shadow-sm transition-colors no-break"></span>
                </div>

                <div>
                    <label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</label>
                    <div class="bg-red-50 border-l-4 border-red-400 rounded-r-lg p-2.5">
                        <p id="modalSeverity" class="text-red-700 font-bold text-xs sm:text-sm"></p>
                    </div>
                </div>

                <div>
                    <label
                        class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 max-h-32 overflow-y-auto text-xs sm:text-sm text-gray-600 leading-relaxed"
                        id="modalDetails"></div>
                </div>

                <div id="modalImageContainer" class="hidden animate-fade-in mt-2 space-y-1">
                    </div>
            </div>
            <div class="p-3 bg-gray-50 border-t shrink-0 text-right">
                <button onclick="closeModal()"
                    class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-gray-100">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="scannerModal"
        class="hidden fixed inset-0 bg-gray-900/90 backdrop-blur-sm flex justify-center items-center z-[10001] p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden relative flex flex-col">
            <div class="bg-gray-800 p-3 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center gap-2 text-sm"><i class="fa-solid fa-qrcode"></i> ‡∏™‡πÅ‡∏Å‡∏ô
                    HN / AN</h3>
                <button onclick="stopScanner()"
                    class="text-gray-400 hover:text-white w-7 h-7 rounded-full flex items-center justify-center transition-colors"><i
                        class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div
                class="p-0 bg-black relative flex-1 min-h-[250px] flex items-center justify-center overflow-hidden bg-black">
                <div id="reader" class="w-full h-full bg-black"></div>
                <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
                    <div class="w-56 h-32 border-2 border-teal-400/80 rounded-lg relative">
                        <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-teal-400 -mt-1 -ml-1">
                        </div>
                        <div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-teal-400 -mt-1 -mr-1">
                        </div>
                        <div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-teal-400 -mb-1 -ml-1">
                        </div>
                        <div
                            class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-teal-400 -mb-1 -mr-1">
                        </div>
                        <div
                            class="absolute top-0 left-0 w-full h-0.5 bg-red-500/80 shadow-[0_0_10px_rgba(239,68,68,0.8)] animate-[scan_2s_infinite]">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading"
        class="hidden fixed inset-0 bg-white/80 backdrop-blur-md flex flex-col justify-center items-center z-[9999]">
        <div class="relative flex justify-center items-center mb-6">
            <div class="absolute animate-ping inline-flex h-16 w-16 rounded-full bg-blue-400 opacity-20"></div>
            <div class="relative animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-500"></div>
        </div>
        <p class="text-gray-600 font-bold text-base animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
    </div>

    <script>
        // ‚úÖ URL API ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const API_URL = "https://script.google.com/macros/s/AKfycbxu8ehD8m8n-i1OZYDl4WJmWnafaHileMZMGwvoVOZH07McEVB73ZpjQPcPylhSjpP_oA/exec";

        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        const rowsPerPage = 15;
        let isDashboardLoaded = false;
        let html5QrCode = null;

        // ‚úÖ 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Drag & Drop ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á Script
        document.addEventListener('DOMContentLoaded', () => {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');

            if (dropArea) {
                // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô default behavior (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ drop ‡πÑ‡∏î‡πâ)
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                // Highlight ‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô .file-upload)
                const innerBox = dropArea.querySelector('.file-upload');

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => innerBox.classList.add('dragover'), false);
                });

                // Unhighlight ‡∏ï‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠ drop
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => innerBox.classList.remove('dragover'), false);
                });

                // Handle Drop
                dropArea.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;

                    if (files.length > 0) {
                        fileInput.files = files; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ input
                        previewImage(fileInput); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Preview
                    }
                }, false);
            }
        });

        function switchTab(tabName) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-form').className = "flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold text-gray-500 hover:text-gray-700 transition-all no-break text-center";
            document.getElementById('tab-dashboard').className = "flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold text-gray-500 hover:text-gray-700 transition-all no-break text-center";

            document.getElementById('tab-' + tabName).className = "flex-1 sm:flex-none px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all shadow bg-white text-blue-600 no-break text-center";

            document.getElementById('view-' + tabName).classList.remove('hidden');

            if (tabName === 'dashboard' && !isDashboardLoaded) {
                loadDashboardData();
                isDashboardLoaded = true;
            } else if (tabName === 'dashboard' && isDashboardLoaded) {
                setTimeout(() => {
                    if (myTypeChart) myTypeChart.resize();
                    if (mySevChart) mySevChart.resize();
                }, 100);
            }
        }

        document.querySelector('input[type="date"]').valueAsDate = new Date();

        loadDashboardData();
        isDashboardLoaded = true;

        function selectType(typeName, typeId, btn) {
            document.getElementById('meType').value = typeName;
            document.querySelectorAll('.btn-type').forEach(b => {
                b.classList.remove('selected', 'border-teal-400', 'bg-teal-50', 'border-pink-400', 'bg-pink-50', 'border-orange-400', 'bg-orange-50');
                b.classList.add('bg-white', 'border-gray-100');
            });
            btn.classList.remove('bg-white', 'border-gray-100');
            btn.classList.add('selected');
            if (typeId === 1) btn.classList.add('border-teal-400', 'bg-teal-50');
            else if (typeId === 2) btn.classList.add('border-pink-400', 'bg-pink-50');
            else if (typeId === 3) btn.classList.add('border-orange-400', 'bg-orange-50');
            document.getElementById('detailSection').classList.remove('hidden');
            const detailInput = document.getElementById('meDetails');
            detailInput.value = "";
            detailInput.placeholder = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";
            detailInput.focus();
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö UI)
        function previewImage(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB', 'warning');
                    input.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // ‡∏ã‡πà‡∏≠‡∏ô Folder Animation
                    document.getElementById('dropArea').classList.add('hidden');
                    // ‡πÅ‡∏™‡∏î‡∏á Preview Container
                    document.getElementById('previewContainer').classList.remove('hidden');
                    
                    const img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö UI ‡∏Å‡∏•‡∏±‡∏ö)
        function removeImage() {
            document.getElementById('fileInput').value = "";
            document.getElementById('imgPreview').src = "";
            
            // ‡∏ã‡πà‡∏≠‡∏ô Preview Container
            document.getElementById('previewContainer').classList.add('hidden');
            // ‡πÅ‡∏™‡∏î‡∏á Folder Animation ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            document.getElementById('dropArea').classList.remove('hidden');
        }

        function resetForm() {
            document.getElementById('meForm').reset();
            document.getElementById('detailSection').classList.add('hidden');
            document.querySelector('input[type="date"]').valueAsDate = new Date();
            document.querySelectorAll('.btn-type').forEach(b => {
                b.classList.remove('selected', 'border-teal-400', 'bg-teal-50', 'border-pink-400', 'bg-pink-50', 'border-orange-400', 'bg-orange-50');
                b.classList.add('bg-white', 'border-gray-100');
            });
            removeImage(); // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleFormSubmit (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        function handleFormSubmit(e) {
            e.preventDefault();
            const meType = document.getElementById('meType').value;
            const severity = document.getElementById('severity').value;
            if (!meType) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô', 'warning'); return; }
            if (!severity) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á', 'warning'); return; }
            
            document.getElementById('loading').classList.remove('hidden');
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.action = 'save';

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Promise ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
            const processSubmission = new Promise((resolve, reject) => {
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        data.imageFile = event.target.result.split(',')[1]; // ‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô Base64
                        data.imageMime = file.type;
                        resolve(data);
                    };
                    reader.readAsDataURL(file);
                } else {
                    resolve(data); 
                }
            });

            processSubmission.then((finalData) => {
                fetch(API_URL, { method: "POST", body: JSON.stringify(finalData), headers: { "Content-Type": "text/plain" } })
                    .then(response => response.json())
                    .then(result => {
                        document.getElementById('loading').classList.add('hidden');
                        if (result.status === 'success') {
                            Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', timer: 1500, showConfirmButton: false, backdrop: `rgba(0,0,123,0.1)` })
                            .then(() => {
                                resetForm();
                            });
                        } else {
                            Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (result.message || ""), 'error');
                        }
                    })
                    .catch(error => {
                        document.getElementById('loading').classList.add('hidden');
                        Swal.fire('Error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                    });
            });
        }

        function startScanner() {
            document.getElementById('scannerModal').classList.remove('hidden');
            setTimeout(() => {
                if (html5QrCode === null) { html5QrCode = new Html5Qrcode("reader"); }
                const config = { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0 };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch(err => { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ', 'error'); stopScanner(); });
            }, 100);
        }

        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('hnInput').value = decodedText;
            stopScanner();
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true });
            Toast.fire({ icon: 'success', title: '‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + decodedText });
        }

        function onScanFailure(error) { }

        function stopScanner() {
            document.getElementById('scannerModal').classList.add('hidden');
            if (html5QrCode) { html5QrCode.stop().then(() => { html5QrCode.clear(); }).catch(err => console.log(err)); }
        }

        function loadDashboardData() {
            document.getElementById('loading').classList.remove('hidden');
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'getRecords' }), headers: { "Content-Type": "text/plain" } })
                .then(response => response.json())
                .then(result => {
                    allRecords = result.data || [];
                    applyTableFilters();
                    document.getElementById('loading').classList.add('hidden');
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, timerProgressBar: true });
                    Toast.fire({ icon: 'success', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' });
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('loading').classList.add('hidden');
                });
        }

        function updateDashboardStats(records) {
            document.getElementById('totalCount').textContent = records.length;
            const typeCounts = {};
            const nameMapping = { '‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥': '‡πÅ‡∏û‡πâ‡∏¢‡∏≤‡∏ã‡πâ‡∏≥', '‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô': '‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô', 'ME ‡∏£‡∏∞‡∏î‡∏±‡∏ö E ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ': '‡∏£‡∏∞‡∏î‡∏±‡∏ö E+' };
            records.forEach(r => {
                const rawType = r.meType;
                const shortName = nameMapping[rawType] || rawType;
                typeCounts[shortName] = (typeCounts[shortName] || 0) + 1;
            });
            const severityCounts = {};
            records.forEach(r => {
                const sev = (r.severity || "").split(' ')[0];
                if (sev) severityCounts[sev] = (severityCounts[sev] || 0) + 1;
            });
            const sortedSevKeys = Object.keys(severityCounts).sort();
            const sortedSevCounts = {};
            sortedSevKeys.forEach(k => sortedSevCounts[k] = severityCounts[k]);
            renderCharts({ typeCounts: typeCounts, severityCounts: sortedSevCounts, total: records.length });
        }

        let myTypeChart, mySevChart;
        function renderCharts(data) {
            const typeLabels = Object.keys(data.typeCounts).map(label => {
                const value = data.typeCounts[label];
                const percent = data.total > 0 ? ((value / data.total) * 100).toFixed(1) : 0;
                return `${label} (${percent}%)`;
            });
            const ctxType = document.getElementById('typeChart').getContext('2d');
            if (myTypeChart) myTypeChart.destroy();
            myTypeChart = new Chart(ctxType, {
                type: 'doughnut',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: Object.values(data.typeCounts),
                        backgroundColor: ['#2dd4bf', '#f472b6', '#fb923c', '#818cf8', '#94a3b8'],
                        borderColor: '#ffffff', borderWidth: 3, hoverOffset: 15, hoverBorderColor: '#ffffff', hoverBorderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '65%',
                    plugins: {
                        legend: { position: 'right', labels: { usePointStyle: true, padding: 15, font: { family: 'Sarabun', size: 11 } } },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1, padding: 10, boxPadding: 4, usePointStyle: true,
                            callbacks: { label: function (context) { return ' ' + context.raw + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'; } }
                        }
                    }, animation: { animateScale: true, animateRotate: true }
                }
            });

            const ctxSev = document.getElementById('severityChart').getContext('2d');
            const gradientBlue = ctxSev.createLinearGradient(0, 0, 0, 400);
            gradientBlue.addColorStop(0, 'rgba(59, 130, 246, 1)'); gradientBlue.addColorStop(1, 'rgba(147, 197, 253, 0.3)');
            const gradientRed = ctxSev.createLinearGradient(0, 0, 0, 400);
            gradientRed.addColorStop(0, 'rgba(239, 68, 68, 1)'); gradientRed.addColorStop(1, 'rgba(252, 165, 165, 0.3)');

            if (mySevChart) mySevChart.destroy();
            const sevLabels = Object.keys(data.severityCounts);
            const sevData = Object.values(data.severityCounts);
            const backgroundColors = sevLabels.map(label => { return ['E', 'F', 'G', 'H', 'I'].some(l => label.startsWith(l)) ? gradientRed : gradientBlue; });

            mySevChart = new Chart(ctxSev, {
                type: 'bar',
                data: {
                    labels: sevLabels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: sevData, backgroundColor: backgroundColors, borderColor: 'transparent', borderWidth: 0, borderRadius: 6, barPercentage: 0.6, categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1, padding: 10, displayColors: false, callbacks: { title: function (context) { return '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á: ' + context[0].label; }, label: function (context) { let value = context.raw; let total = data.total; let percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; return ' ' + value + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (' + percentage + '%)'; } } } }, scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6', borderDash: [4, 4] }, ticks: { font: { family: 'Sarabun', size: 10 }, stepSize: 1 } }, x: { grid: { display: false }, ticks: { font: { family: 'Sarabun', size: 10 } } } }
                }
            });
        }

        function applyTableFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            const filterSev = document.getElementById('filterSeverity').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            filteredRecords = allRecords.filter(item => {
                const matchSearch = (item.hn + item.details).toLowerCase().includes(search);
                const matchType = filterType === "" || item.meType === filterType;
                const matchSev = filterSev === "" || (item.severity && item.severity.startsWith(filterSev));
                let matchDate = true;
                if (startDate || endDate) {
                    const itemDate = new Date(item.date);
                    if (startDate) matchDate = matchDate && (itemDate >= new Date(startDate));
                    if (endDate) matchDate = matchDate && (itemDate <= new Date(endDate));
                }
                return matchSearch && matchType && matchSev && matchDate;
            });
            updateDashboardStats(filteredRecords);
            currentPage = 1; renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = filteredRecords.slice(start, end);
            if (paginatedItems.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8 text-gray-400"><i class="fa-solid fa-folder-open text-xl mb-2"></i><br>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`; document.getElementById('pageIndicator').innerText = `0 / 0`; return; }
            let html = "";
            paginatedItems.forEach((item, index) => {
                let badgeClass = "bg-gray-100 text-gray-600";
                if (item.severity.startsWith("E") || item.severity.startsWith("F")) badgeClass = "bg-orange-100 text-orange-600";
                if (item.severity.startsWith("G") || item.severity.startsWith("H") || item.severity.startsWith("I")) badgeClass = "bg-red-100 text-red-600";
                
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥
                html += `
                <tr onclick="openRecordModal(${start + index})" class="hover:bg-blue-50 cursor-pointer group transition-colors border-b border-gray-50 last:border-0">
                    <td class="px-3 py-2 whitespace-nowrap text-gray-500 group-hover:text-blue-600 font-medium no-break">${formatDate(item.date)}</td>
                    <td class="px-3 py-2 font-bold text-gray-700 no-break">${item.hn}</td>
                    <td class="px-3 py-2"><span class="text-[10px] sm:text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200 no-break">${item.meType}</span></td>
                    <td class="px-3 py-2 text-gray-600 truncate max-w-[150px] sm:max-w-[200px]" title="${item.details || ''}">${item.details || "-"}</td>
                    <td class="px-3 py-2 text-center"><span class="${badgeClass} px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-extrabold border border-white shadow-sm no-break">${item.severity.split(' ')[0]}</span></td>
                </tr>`;
            });
            tbody.innerHTML = html;
            const totalPages = Math.ceil(filteredRecords.length / rowsPerPage);
            document.getElementById('pageIndicator').innerText = `${currentPage} / ${totalPages}`;
        }

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô Modal ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Google Drive ‡πÅ‡∏ö‡∏ö Thumbnail ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Image Error
        function openRecordModal(index) {
            const item = filteredRecords[index];
            if (!item) return;

            document.getElementById('modalDate').textContent = formatDate(item.date);
            document.getElementById('modalHN').textContent = item.hn;
            document.getElementById('modalReporter').textContent = item.reporter || "-";
            const typeSpan = document.getElementById('modalType');
            typeSpan.textContent = item.meType;
            typeSpan.className = "inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs sm:text-sm font-bold text-white shadow-md no-break";
            
            if (item.meType.includes('‡πÅ‡∏û‡πâ')) typeSpan.classList.add('bg-teal-500');
            else if (item.meType.includes('‡∏ú‡∏¥‡∏î‡∏Ñ‡∏ô')) typeSpan.classList.add('bg-pink-500');
            else typeSpan.classList.add('bg-orange-500');
            
            document.getElementById('modalSeverity').textContent = item.severity;
            document.getElementById('modalDetails').textContent = item.details || "-";

            const imgContainer = document.getElementById('modalImageContainer');
            
            if (item.imageUrl && item.imageUrl !== "-" && !item.imageUrl.startsWith("Error")) {
                let directUrl = item.imageUrl;
                let fileId = "";

                // ‡∏î‡∏∂‡∏á File ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå Thumbnail
                if (directUrl.includes("/d/")) {
                    try { fileId = directUrl.split('/d/')[1].split('/')[0]; } catch (e) {}
                } else if (directUrl.includes("id=")) {
                    try { fileId = directUrl.split('id=')[1].split('&')[0]; } catch (e) {}
                }

                if (fileId) {
                    // ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Thumbnail ‡πÅ‡∏ó‡∏ô
                    directUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                }

                imgContainer.innerHTML = `
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 no-break">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <div class="rounded-lg overflow-hidden border border-gray-200 group relative bg-gray-100 flex justify-center items-center min-h-[150px]">
                        <div class="spinner center" id="loadingSpinner">
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                            <div class="spinner-blade"></div>
                        </div>

                        <img src="${directUrl}" 
                             class="w-full h-auto object-cover max-h-60 opacity-0 transition-opacity duration-500" 
                             onclick="window.open('${item.imageUrl}', '_blank')" 
                             style="cursor: pointer;"
                             referrerpolicy="no-referrer"
                             onload="this.classList.remove('opacity-0'); document.getElementById('loadingSpinner').style.display='none';"
                             onerror="this.onerror=null; document.getElementById('loadingSpinner').style.display='none'; this.parentElement.innerHTML='<div class=\\'text-center p-4\\'><p class=\\'text-xs text-red-400 mb-2\\'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ</p><a href=\\'${item.imageUrl}\\' target=\\'_blank\\' class=\\'bg-blue-500 text-white px-3 py-1 rounded text-xs\\'>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a></div>';">
                        
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 pointer-events-none transition-colors"></div>
                        <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                            <i class="fa-solid fa-magnifying-glass"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏†‡∏≤‡∏û‡πÄ‡∏ï‡πá‡∏°
                        </div>
                    </div>
                `;
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.innerHTML = "";
                imgContainer.classList.add('hidden');
            }

            document.getElementById('detailModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
        function changePage(d) { const total = Math.ceil(filteredRecords.length / rowsPerPage); if ((d === -1 && currentPage > 1) || (d === 1 && currentPage < total)) { currentPage += d; renderTable(); } }
        function formatDate(d) { if (!d) return "-"; return new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); }
        function exportToExcel() {
            if (filteredRecords.length === 0) { Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export', 'info'); return; }
            let csv = "data:text/csv;charset=utf-8,\uFEFFTimestamp,Date,HN,Type,Details,Severity,Reporter,ImageURL\n";
            filteredRecords.forEach(r => {
                csv += `${r.timestamp},${r.date},${r.hn},${r.meType},${(r.details || "").replace(/,/g, " ")},${(r.severity || "").split(' ')[0]},${r.reporter || "-"},${r.imageUrl || "-"}\n`;
            });
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "ME_Report.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
      @keyframes scan {
        0%, 100% { top: 0; }
        50% { top: 100%; }
      }
    `;
        document.head.appendChild(styleSheet);
    </script>
</body>

</html>
