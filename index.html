<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Serious ME Notify</title>
    <link rel="shortcut icon" href="icons/icon.ico" type="image/x-icon">

    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ME Notify">
    <link rel="apple-touch-icon" href="icons/icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js and DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: { brand: { blue: '#2563eb', light: '#eff6ff' } }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .btn-type {
            transition: all 0.2s;
            position: relative;
            border-width: 2px;
        }

        .btn-type:active {
            transform: scale(0.95);
        }

        .btn-type.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px -3px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .checkmark {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10B981;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        .btn-type.selected .checkmark {
            opacity: 1;
            transform: scale(1);
        }

        .severity-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            border: 1px solid transparent;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .image-item {
            position: relative;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            background: #fff;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .image-remove:hover {
            transform: scale(1.1);
            background: red;
        }

        .tab-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-button.active {
            background-color: #ffffff;
            color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: scale(1.02);
        }

        .tab-button:not(.active) {
            color: #e0e7ff;
        }

        .tab-button:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .no-break {
            whitespace: nowrap;
        }

        /* Spinner Styles */
        .spinner {
            background-image: linear-gradient(rgb(186, 66, 255) 35%, rgb(0, 225, 255));
            width: 100px;
            height: 100px;
            animation: spinning82341 1.7s linear infinite;
            text-align: center;
            border-radius: 50px;
            filter: blur(1px);
            box-shadow: 0px -5px 20px 0px rgb(186, 66, 255), 0px 5px 20px 0px rgb(0, 225, 255);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner1 {
            background-color: rgb(36, 36, 36);
            width: 100px;
            height: 100px;
            border-radius: 50px;
            filter: blur(10px);
            transform: scale(0.9);
        }

        .spinner1.white {
            background-color: rgb(255, 255, 255);
        }

        @keyframes spinning82341 {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner-mini {
            transform: scale(0.3);
            transform-origin: center;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col bg-gray-50">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg sticky top-0 z-30">
        <div class="w-full px-4 py-3 sm:py-4 flex flex-col sm:flex-row justify-between items-center gap-3 sm:gap-0">
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <div class="bg-white/10 p-1.5 rounded-lg backdrop-blur-sm flex items-center justify-center">
                    <img src="../icons/hoslogo.png" alt="โรงพยาบาลอุตรดิตถ์" class="h-12 w-auto">
                </div>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold leading-tight">ระบบรายงานอุบัติการณ์ ME</h1>
                    <p class="text-blue-100 text-xs mt-0.5">กลุ่มงานเภสัชกรรม รพ.อุตรดิตถ์</p>
                </div>
            </div>

            <div class="flex bg-black/20 rounded-xl p-1 gap-1 w-full sm:w-auto">
                <button onclick="switchTab('form')" id="tab-form"
                    class="tab-button active flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-edit"></i> บันทึกข้อมูล
                </button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard"
                    class="tab-button flex-1 sm:flex-none px-6 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-chart-pie"></i> แดชบอร์ด
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-3 sm:p-6 lg:p-8 overflow-y-auto">
        <div class="w-full max-w-full mx-auto">

            <!-- FORM TAB -->
            <div id="view-form" class="animate-fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden max-w-7xl mx-auto">
                    <div
                        class="bg-gradient-to-r from-orange-400 to-orange-500 p-3 sm:p-4 text-white font-bold text-lg flex items-center gap-2">
                        <i class="fas fa-clipboard-list"></i> ฟอร์มบันทึกข้อมูล
                    </div>

                    <div class="p-4 sm:p-8">
                        <form id="meForm">
                            <input type="hidden" name="rowId" id="editRowId">

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">วันที่เกิดเหตุ <span
                                            class="text-red-500">*</span></label>
                                    <input type="date" name="incidentDate" id="incidentDate" required
                                        class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">HN / AN ผู้ป่วย <span
                                            class="text-red-500">*</span></label>
                                    <div class="flex gap-2">
                                        <input type="text" id="hnInput" name="hn" required
                                            placeholder="ระบุเลข HN หรือ AN"
                                            class="flex-1 px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow"
                                            inputmode="numeric">
                                        <!-- Scan Button with Text -->
                                        <button type="button" onclick="startScanner()"
                                            class="px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg border border-gray-300 transition-colors flex items-center justify-center gap-2 whitespace-nowrap">
                                            <i class="fas fa-camera text-lg"></i>
                                            <span class="font-semibold text-sm">สแกน</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ชื่อผู้รายงาน <span
                                        class="text-red-500">*</span></label>
                                <input type="text" name="reporter" id="reporter" required
                                    placeholder="ระบุชื่อผู้รายงาน"
                                    class="w-full px-4 py-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-shadow">
                            </div>

                            <div class="mb-8">
                                <p class="text-center text-sm font-semibold text-gray-500 mb-3">
                                    เลือกประเภทความคลาดเคลื่อน</p>
                                <input type="hidden" name="meType" id="meType">
                                <div class="grid grid-cols-3 gap-3 sm:gap-6">
                                    <button type="button" onclick="selectType('แพ้ยาซ้ำ', 1, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-teal-200 rounded-xl p-3 flex flex-col items-center justify-center gap-2 h-24 sm:h-32 shadow-sm hover:bg-teal-50 hover:shadow-md">
                                        <div
                                            class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-teal-100 text-teal-500 flex items-center justify-center text-lg sm:text-2xl group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-pills"></i>
                                        </div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-teal-700 text-xs sm:text-base text-center">แพ้ยาซ้ำ</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                    <button type="button" onclick="selectType('จ่ายยาผิดคน', 2, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-pink-200 rounded-xl p-3 flex flex-col items-center justify-center gap-2 h-24 sm:h-32 shadow-sm hover:bg-pink-50 hover:shadow-md">
                                        <div
                                            class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-lg sm:text-2xl group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-user-xmark"></i>
                                        </div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-pink-700 text-xs sm:text-base text-center">ผิดคน</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                    <button type="button" onclick="selectType('ME ระดับ E ขึ้นไป', 3, this)"
                                        class="btn-type group relative bg-white border-2 border-gray-100 hover:border-orange-200 rounded-xl p-3 flex flex-col items-center justify-center gap-2 h-24 sm:h-32 shadow-sm hover:bg-orange-50 hover:shadow-md">
                                        <div
                                            class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center text-lg sm:text-2xl group-hover:scale-110 transition-transform">
                                            <i class="fa-solid fa-triangle-exclamation"></i>
                                        </div>
                                        <span
                                            class="font-bold text-gray-600 group-hover:text-orange-700 text-xs sm:text-base text-center">ระดับ
                                            E+</span>
                                        <div class="checkmark"><i class="fa-solid fa-check text-xs"></i></div>
                                    </button>
                                </div>
                            </div>

                            <div id="detailSection"
                                class="hidden space-y-6 border-t border-dashed border-gray-200 pt-6 animate-fade-in">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">รายละเอียด <span
                                            class="text-red-500">*</span></label>
                                    <textarea name="meDetails" id="meDetails" rows="3" required
                                        class="w-full p-3 rounded-lg bg-gray-50 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none resize-none transition-shadow"
                                        placeholder="รายละเอียดเพิ่มเติม"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ระดับความรุนแรง <span
                                            class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <select name="severity" id="severity" required
                                            class="w-full p-2.5 pl-3 pr-8 rounded-lg bg-gray-50 border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none appearance-none transition-shadow">
                                            <option value="">-- เลือกระดับความรุนแรง --</option>
                                            <option value="A">【 A 】 มีโอกาสเกิด แต่ยังไม่เกิด</option>
                                            <option value="B">【 B 】 เกิดแล้ว แต่ไม่ถึงผู้ป่วย</option>
                                            <option value="C">【 C 】 ถึงผู้ป่วย แต่ไม่เป็นอันตราย</option>
                                            <option value="D">【 D 】 ถึงผู้ป่วย ต้องเฝ้าระวัง</option>
                                            <option value="E">【 E 】 เป็นอันตรายชั่วคราว/ต้องรักษา</option>
                                            <option value="F">【 F 】 ต้องนอน รพ./ยืดเวลานอน รพ.</option>
                                            <option value="G">【 G 】 เป็นอันตรายถาวร</option>
                                            <option value="H">【 H 】 ต้องกู้ชีพ/ช่วยชีวิต</option>
                                            <option value="I">【 I 】 เสียชีวิต</option>
                                        </select>
                                        <div
                                            class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                                            <i class="fas fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Image Upload -->
                                <div class="mt-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">รูปภาพ (ถ้ามี)</label>
                                    <div id="dropArea"
                                        class="w-full p-6 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-blue-50 hover:border-blue-400 transition-colors cursor-pointer text-center group">
                                        <input type="file" id="fileInput" accept="image/*" multiple class="hidden"
                                            onchange="handleFileSelect(this)">
                                        <div class="pointer-events-none">
                                            <div
                                                class="w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm flex items-center justify-center text-blue-500 mx-auto mb-2 group-hover:scale-110 transition-transform">
                                                <i class="fas fa-cloud-arrow-up text-xl"></i>
                                            </div>
                                            <p class="text-sm font-bold text-gray-600 group-hover:text-blue-600 transition-colors"
                                                id="dropText">คลิก หรือ ลากไฟล์มาวาง</p>
                                            <p class="text-xs text-gray-400">รองรับไฟล์รูปภาพ (สูงสุด 10MB)</p>
                                        </div>
                                    </div>
                                    <!-- Image Grid -->
                                    <div id="imageGrid"
                                        class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mt-4"></div>
                                </div>

                                <div class="flex gap-3 pt-4 border-t">
                                    <!-- Equal width buttons: Both use flex-1 -->
                                    <button type="button" onclick="resetForm()"
                                        class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-500 font-bold hover:bg-gray-50 transition-all">ยกเลิก</button>
                                    <button type="submit" id="submitBtn"
                                        class="flex-1 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold shadow-lg hover:shadow-blue-500/30 transition-all hover:-translate-y-0.5 active:scale-95">
                                        <i class="fas fa-paper-plane mr-2"></i> บันทึกข้อมูล
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="view-dashboard" class="hidden animate-fade-in pb-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h3 class="font-bold text-xl text-gray-800">ภาพรวมข้อมูล</h3>
                        <p class="text-sm text-gray-500">ข้อมูลจาก Firebase Firestore</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="exportToExcel()"
                            class="flex-1 md:flex-none bg-green-50 text-green-700 border border-green-200 px-4 py-2 rounded-lg font-bold hover:bg-green-100 transition-colors text-sm shadow-sm"><i
                                class="fas fa-file-excel mr-1"></i> Export</button>
                        <button onclick="window.refreshData()"
                            class="flex-1 md:flex-none bg-blue-50 text-blue-700 border border-blue-200 px-4 py-2 rounded-lg font-bold hover:bg-blue-100 transition-colors text-sm shadow-sm"><i
                                class="fas fa-sync-alt mr-1"></i> อัปเดต</button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-xs text-gray-500 font-bold uppercase">ทั้งหมด</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-total">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-xs text-teal-600 font-bold uppercase">แพ้ยาซ้ำ</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-allergy">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-xs text-pink-600 font-bold uppercase">ผิดคน</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-wrong">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-xs text-orange-600 font-bold uppercase">ระดับ E+</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" id="stat-severe">0</h3>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-gray-700 mb-4 text-sm">สัดส่วนประเภทความคลาดเคลื่อน</h4>
                        <div class="h-64 relative flex justify-center"><canvas id="typeChart"></canvas></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        <h4 class="font-bold text-gray-700 mb-4 text-sm">จำนวนตามระดับความรุนแรง</h4>
                        <div class="h-64 relative"><canvas id="severityChart"></canvas></div>
                    </div>
                </div>

                <!-- Table & Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <!-- Filters Section -->
                    <div class="p-4 border-b bg-gray-50 flex flex-wrap md:flex-nowrap items-center gap-3">
                        <!-- Search & Main Filters -->
                        <div class="flex flex-1 flex-wrap md:flex-nowrap gap-3 w-full">
                            <div class="relative flex-1 min-w-[200px]">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="searchInput" placeholder="ค้นหา HN, รายละเอียด..."
                                    class="w-full pl-9 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 text-sm"
                                    onkeyup="applyTableFilters()">
                            </div>
                            <select id="filterType"
                                class="border rounded-lg px-3 py-2 text-sm outline-none flex-shrink-0"
                                onchange="applyTableFilters()">
                                <option value="">ทุกประเภท</option>
                                <option value="แพ้ยาซ้ำ">แพ้ยาซ้ำ</option>
                                <option value="จ่ายยาผิดคน">ผิดคน</option>
                                <option value="ME ระดับ E ขึ้นไป">E+</option>
                            </select>
                            <select id="filterSeverity"
                                class="border rounded-lg px-3 py-2 text-sm outline-none flex-shrink-0"
                                onchange="applyTableFilters()">
                                <option value="">ทุกระดับ</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="H">H</option>
                                <option value="I">I</option>
                            </select>
                        </div>

                        <!-- Date & Reset Button -->
                        <div class="flex flex-wrap items-center gap-2 ml-auto w-full md:w-auto justify-end">
                            <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-gray-200 text-sm">
                                <span class="text-gray-500 text-xs ml-1"><i class="far fa-calendar-alt"></i></span>
                                <input type="date" id="filterStartDate"
                                    class="border-none outline-none text-xs p-1 w-28 bg-transparent"
                                    onchange="applyTableFilters()">
                                <span class="text-gray-400">-</span>
                                <input type="date" id="filterEndDate"
                                    class="border-none outline-none text-xs p-1 w-28 bg-transparent"
                                    onchange="applyTableFilters()">
                            </div>
                            <button onclick="resetFilters()"
                                class="flex-1 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 rounded-lg h-8 px-4 font-bold text-xs transition-colors flex items-center justify-center gap-2 min-w-[120px]"
                                title="ล้างตัวกรอง">
                                <i class="fas fa-times-circle"></i> ล้างตัวกรอง
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-4 py-3 whitespace-nowrap">วันที่</th>
                                    <th class="px-4 py-3 whitespace-nowrap">HN/AN</th>
                                    <th class="px-4 py-3 whitespace-nowrap">ประเภท</th>
                                    <th class="px-4 py-3 min-w-[200px]">รายละเอียด</th>
                                    <th class="px-4 py-3 whitespace-nowrap text-center">ระดับ</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-gray-400">รอการโหลดข้อมูล...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 border-t bg-gray-50 flex justify-between items-center text-sm"><button
                            onclick="changePage(-1)"
                            class="px-3 py-1 bg-white border rounded hover:bg-gray-50">ก่อนหน้า</button><span
                            id="pageIndicator" class="font-bold text-blue-600">1 / 1</span><button
                            onclick="changePage(1)"
                            class="px-3 py-1 bg-white border rounded hover:bg-gray-50">ถัดไป</button></div>
                </div>
                <p class="text-center text-xs text-gray-400 mt-8">© 2025 กลุ่มงานเภสัชกรรม โรงพยาบาลอุตรดิตถ์</p>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="scannerModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl relative flex flex-col">
            <div class="p-3 bg-gray-800 text-white flex justify-between items-center"><span
                    class="font-bold">สแกนโค้ด</span><button onclick="stopScanner()"><i
                        class="fas fa-times"></i></button></div>
            <div id="reader" class="w-full bg-black flex-1 min-h-[300px]"></div>
        </div>
    </div>

    <div id="detailModal"
        class="hidden fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white w-full max-w-lg rounded-2xl shadow-xl overflow-hidden max-h-[90vh] flex flex-col animate-fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold text-lg">รายละเอียด</h3><button onclick="closeModal()"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-5 overflow-y-auto space-y-4 bg-gray-50/50">
                <div class="flex gap-3">
                    <div class="w-1/2 bg-white p-3 rounded-lg border border-gray-200 shadow-sm"><span
                            class="text-xs font-bold text-gray-400 uppercase block mb-1">วันที่</span><span
                            id="modalDate" class="font-bold text-gray-800"></span></div>
                    <div class="w-1/2 bg-white p-3 rounded-lg border border-gray-200 shadow-sm"><span
                            class="text-xs font-bold text-gray-400 uppercase block mb-1">HN/AN</span><span id="modalHN"
                            class="font-bold text-blue-600"></span></div>
                </div>
                <div><span class="text-xs font-bold text-gray-400 uppercase">ผู้รายงาน</span>
                    <div id="modalReporter"
                        class="font-medium text-gray-700 bg-white p-2 rounded border border-gray-200 mt-1"></div>
                </div>
                <div class="flex items-center justify-between">
                    <div><span class="text-xs font-bold text-gray-400 uppercase block">ประเภท</span>
                        <div id="modalTypeContainer" class="mt-1"></div>
                    </div>
                    <div class="text-right"><span class="text-xs font-bold text-gray-400 uppercase block">ระดับ</span>
                        <div id="modalSeverity" class="inline-flex mt-1"></div>
                    </div>
                </div>
                <div><span class="text-xs font-bold text-gray-400 uppercase">รายละเอียด</span>
                    <div id="modalDetails"
                        class="p-3 bg-white border border-gray-200 rounded-lg text-sm text-gray-600 mt-1 leading-relaxed max-h-40 overflow-y-auto">
                    </div>
                </div>
                <div><span class="text-xs font-bold text-gray-400 uppercase mb-2 block">รูปภาพ</span>
                    <div id="modalGallery" class="flex gap-2 overflow-x-auto py-2 no-scrollbar"></div>
                </div>
            </div>
            <div class="p-4 border-t bg-white flex gap-3"><button onclick="deleteRecord()"
                    class="flex-1 py-2.5 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100 hover:bg-red-100"><i
                        class="fas fa-trash-alt mr-2"></i> ลบ</button><button onclick="editRecord()"
                    class="flex-1 py-2.5 bg-yellow-50 text-yellow-700 font-bold rounded-xl border border-yellow-100 hover:bg-yellow-100"><i
                        class="fas fa-edit mr-2"></i> แก้ไข</button><button onclick="closeModal()"
                    class="px-5 py-2.5 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="imageViewerModal"
        class="hidden fixed inset-0 z-[60] bg-black/95 flex justify-center items-center overflow-hidden">
        <button class="absolute top-4 right-4 text-white/80 hover:text-white z-50 p-2" onclick="closeImageViewer()"><i
                class="fas fa-times text-2xl"></i></button>
        <div
            class="absolute bottom-8 left-1/2 -translate-x-1/2 z-50 flex gap-4 bg-white/10 backdrop-blur rounded-full px-6 py-2 border border-white/20">
            <button onclick="adjustZoom(-0.2)" class="text-white hover:text-blue-400"><i
                    class="fas fa-search-minus"></i></button><button onclick="resetZoom()"
                class="text-white hover:text-blue-400 px-2"><i class="fas fa-compress"></i></button><button
                onclick="adjustZoom(0.2)" class="text-white hover:text-blue-400"><i
                    class="fas fa-search-plus"></i></button>
        </div>
        <div class="w-full h-full flex items-center justify-center overflow-hidden cursor-move"
            onmousedown="startDrag(event)" onmousemove="drag(event)" onmouseup="endDrag()" onmouseleave="endDrag()"
            ontouchstart="startDrag(event)" ontouchmove="drag(event)" ontouchend="endDrag()">
            <img id="fullImage" src="" class="max-w-full max-h-full object-contain transition-transform duration-100"
                style="transform: scale(1) translate(0px, 0px);">
        </div>
        <!-- Loader for Image Viewer -->
        <div id="imageLoader" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="spinner">
                <div class="spinner1 white"></div>
            </div>
        </div>
    </div>

    <!-- Global Loading Overlay -->
    <div id="loading"
        class="hidden fixed inset-0 bg-white/80 z-[70] flex flex-col justify-center items-center backdrop-blur-sm">
        <div class="spinner mb-4">
            <div class="spinner1 white"></div>
        </div>
        <p class="text-gray-600 font-semibold animate-pulse">กำลังทำงาน...</p>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyB5zk50EwjRla2ka7p9HYMB3GFrQi4PB_8", authDomain: "me-notice.firebaseapp.com", projectId: "me-notice", storageBucket: "me-notice.firebasestorage.app", messagingSenderId: "274354321560", appId: "1:274354321560:web:edb05ca930f17e9f8ff8ed" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const DB_COLLECTION = "reports";
        window.saveToFirestore = async (data) => {
            try {
                const docData = { date: data.incidentDate, hn: data.hn, meType: data.meType, details: data.meDetails, severity: data.severity, reporter: data.reporter, imageUrl: data.imageUrl || "-", timestamp: Timestamp.now() };
                if (data.rowId) { await updateDoc(doc(db, DB_COLLECTION, data.rowId), docData); } else { await addDoc(collection(db, DB_COLLECTION), docData); }
                return { status: "success" };
            } catch (e) { return { status: "error", message: e.toString() }; }
        };
        window.deleteFromFirestore = async (docId) => { try { await deleteDoc(doc(db, DB_COLLECTION, docId)); return { status: "success" }; } catch (e) { return { status: "error", message: e.toString() }; } };
        window.fetchFromFirestore = async () => { try { const q = query(collection(db, DB_COLLECTION), orderBy("timestamp", "desc")); const querySnapshot = await getDocs(q); return querySnapshot.docs.map(doc => ({ rowId: doc.id, ...doc.data() })); } catch (e) { console.error(e); return []; } };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Error', err));
            });
        }

        window.initFirebase = async () => { loadDashboardData(); }
    </script>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbx1XrQt0IwoxXcYyJVkcoA6MwpCCbtJiHVhPQ5cWBG7HXVJoiYJ2F7Te0V7_Oexx9Q/exec";
        let allRecords = [], filteredRecords = [], currentPage = 1, currentRecord = null, uploadedFiles = [];
        const rowsPerPage = 10;
        let html5QrCode = null;

        // Register Plugin
        Chart.register(ChartDataLabels);

        function switchTab(tabName) {
            document.getElementById('view-form').classList.add('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-' + tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('tab-' + tabName);
            if (activeBtn) activeBtn.classList.add('active');
            if (tabName === 'dashboard') loadDashboardData();
        }

        function selectType(typeName, typeId, btn) {
            document.getElementById('meType').value = typeName;
            document.querySelectorAll('.btn-type').forEach(b => { b.classList.remove('selected', 'border-teal-400', 'bg-teal-50', 'border-pink-400', 'bg-pink-50', 'border-orange-400', 'bg-orange-50'); b.classList.add('bg-white', 'border-gray-100'); });
            btn.classList.remove('bg-white', 'border-gray-100'); btn.classList.add('selected');
            if (typeId === 1) btn.classList.add('border-teal-400', 'bg-teal-50'); else if (typeId === 2) btn.classList.add('border-pink-400', 'bg-pink-50'); else if (typeId === 3) btn.classList.add('border-orange-400', 'bg-orange-50');
            document.getElementById('detailSection').classList.remove('hidden');
            if (!document.getElementById('editRowId').value) document.getElementById('meDetails').focus();
        }

        function handleFileSelect(input) {
            const grid = document.getElementById('imageGrid');
            const dropText = document.getElementById('dropText');

            Array.from(input.files).forEach((file, index) => {
                if (file.size <= 10 * 1024 * 1024) {
                    const tempId = `temp-${Date.now()}-${index}`;
                    const div = document.createElement('div');
                    // Add spinner to the temporary div
                    div.className = 'image-item flex items-center justify-center bg-gray-50';
                    div.id = tempId;
                    div.innerHTML = `<div class="spinner spinner-mini"><div class="spinner1 white"></div></div>`;
                    grid.appendChild(div);

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedFiles.push(file);
                        const finalDiv = document.getElementById(tempId);
                        if (finalDiv) {
                            finalDiv.innerHTML = `
                                <img src="${e.target.result}">
                                <div class="image-remove" onclick="removeFile(${uploadedFiles.length - 1})"><i class="fas fa-times"></i></div>
                            `;
                            finalDiv.classList.remove('flex', 'items-center', 'justify-center', 'bg-gray-100');
                        }
                        updateDropText();
                    };
                    reader.readAsDataURL(file);
                } else {
                    Swal.fire('ไฟล์ใหญ่เกินไป', 'สูงสุด 10MB', 'warning');
                }
            });
            input.value = "";
        }

        function renderPreviews() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = uploadedFiles.map((file, i) => `
                <div class="image-item">
                    <img src="${typeof file === 'string' ? convertDriveLink(file) : URL.createObjectURL(file)}">
                    <div class="image-remove" onclick="removeFile(${i})"><i class="fas fa-times"></i></div>
                </div>
            `).join('');
            updateDropText();
        }

        function updateDropText() {
            const dropText = document.getElementById('dropText');
            dropText.innerHTML = uploadedFiles.length ? `<span class="text-blue-600 font-bold">เลือกแล้ว ${uploadedFiles.length} รูป</span>` : "คลิก หรือ ลากไฟล์มาวาง";
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderPreviews();
        }

        function convertDriveLink(url, size = 'w400') {
            if (!url) return "";
            let id = "";
            if (url.includes("id=")) id = url.split('id=')[1].split('&')[0];
            else if (url.includes("/d/")) id = url.split('/d/')[1].split('/')[0];

            if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=${size}`;
            return url;
        }

        // Modified to fix CSV Export BOM issue AND Format Timestamp
        function exportToExcel() {
            if (filteredRecords.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'แจ้งเตือน',
                    text: 'ไม่มีข้อมูลให้ Export',
                    confirmButtonColor: '#2563eb',
                    customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' }
                });
                return;
            }

            // Helper to format timestamp to readable Thai format: dd/mm/yyyy hh:mm:ss
            const formatTS = (ts) => {
                if (!ts) return "-";

                // 1. กรณีเป็น Firestore Timestamp (มี method toDate)
                if (typeof ts.toDate === 'function') {
                    return ts.toDate().toLocaleString('th-TH');
                }

                // 2. กรณีเป็น Object ที่มี seconds (เช่น JSON)
                if (ts.seconds) {
                    return new Date(ts.seconds * 1000).toLocaleString('th-TH');
                }

                // 3. กรณีเป็น String หรือ Date ปกติ
                try {
                    const d = new Date(ts);
                    if (!isNaN(d.getTime())) return d.toLocaleString('th-TH');
                } catch (e) { }

                return "-";
            };

            // Helper to convert Date "YYYY-MM-DD" to Thai format "DD MMM YYYY"
            const formatThaiDate = (dateString) => {
                if (!dateString) return "-";
                const parts = dateString.split("-");
                if (parts.length !== 3) return dateString;
                const year = parseInt(parts[0]) + 543;
                // Create date object to get month name
                const date = new Date(dateString);
                // Use toLocaleDateString for "DD MMM YYYY" format
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            };

            let csv = "\uFEFFTimestamp,Date,HN,Type,Details,Severity,Reporter,ImageURL\n"; // Add BOM for Thai char support

            filteredRecords.forEach(r => {
                // Escape double quotes in content by replacing " with ""
                const detailsSafe = (r.details || "").replace(/"/g, '""');
                const hnSafe = (r.hn || "").replace(/"/g, '""');
                const reporterSafe = (r.reporter || "").replace(/"/g, '""');
                const formattedTimestamp = formatTS(r.timestamp);
                const formattedDate = formatThaiDate(r.date); // Format incident date

                // Wrap fields in double quotes to handle commas and newlines correctly
                csv += `"${formattedTimestamp}","${formattedDate}","${hnSafe}","${r.meType}","${detailsSafe}","${(r.severity || "").split(' ')[0]}","${reporterSafe}","${r.imageUrl || "-"}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `ME_Report_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('meForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('meType').value) return Swal.fire({ title: 'แจ้งเตือน', text: 'กรุณาเลือกประเภทความคลาดเคลื่อน', icon: 'warning', confirmButtonColor: '#2563eb', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } });
            document.getElementById('loading').classList.remove('hidden');
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.isNewRecord = !data.rowId;
            try {
                const imagesToUpload = [];
                for (const item of uploadedFiles) {
                    if (typeof item === 'string') imagesToUpload.push({ url: item });
                    else {
                        const base64 = await new Promise(r => { const reader = new FileReader(); reader.onload = evt => r(evt.target.result.split(',')[1]); reader.readAsDataURL(item); });
                        imagesToUpload.push({ data: base64, mime: item.type });
                    }
                }
                const gasRes = await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify({ ...data, images: imagesToUpload, action: "uploadService" }), headers: { "Content-Type": "text/plain" } }).then(r => r.json());
                if (gasRes.status !== 'success') throw new Error(gasRes.message);
                data.imageUrl = gasRes.imageUrls;
                await window.saveToFirestore(data);
                Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false, confirmButtonColor: '#2563eb', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } });
                resetForm();
                if (!data.isNewRecord) switchTab('dashboard');
            } catch (err) { Swal.fire({ title: 'Error', text: err.message, icon: 'error', confirmButtonColor: '#ef4444', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } }); } finally { document.getElementById('loading').classList.add('hidden'); }
        });

        function resetForm() {
            document.getElementById('meForm').reset();
            document.getElementById('editRowId').value = "";
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paper-plane mr-2"></i> บันทึกข้อมูล';
            document.getElementById('submitBtn').className = "flex-1 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold shadow-lg hover:shadow-blue-500/30 transition-all hover:-translate-y-0.5 active:scale-95";
            document.querySelectorAll('.btn-type').forEach(b => { b.classList.remove('selected', 'border-teal-400', 'bg-teal-50', 'border-pink-400', 'bg-pink-50', 'border-orange-400', 'bg-orange-50'); b.classList.add('bg-white', 'border-gray-100'); });
            document.getElementById('detailSection').classList.add('hidden');
            uploadedFiles = [];
            renderPreviews();
            // Removed automatic date setting as requested
        }

        async function loadDashboardData() { if (!window.fetchFromFirestore) return setTimeout(loadDashboardData, 500); allRecords = await window.fetchFromFirestore(); applyTableFilters(); }

        function applyTableFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const type = document.getElementById('filterType').value;
            const sev = document.getElementById('filterSeverity').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            filteredRecords = allRecords.filter(r => {
                const matchesSearch = (r.hn.toLowerCase().includes(search) || (r.details || "").toLowerCase().includes(search));
                const matchesType = !type || r.meType === type;
                const matchesSev = !sev || (r.severity || "").startsWith(sev);

                let matchesDate = true;
                if (startDate) matchesDate = matchesDate && (r.date >= startDate);
                if (endDate) matchesDate = matchesDate && (r.date <= endDate);

                return matchesSearch && matchesType && matchesSev && matchesDate;
            });

            currentPage = 1;
            renderDashboard();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterSeverity').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            applyTableFilters();
        }

        function renderDashboard() {
            document.getElementById('stat-total').innerText = filteredRecords.length;
            document.getElementById('stat-allergy').innerText = filteredRecords.filter(r => r.meType === 'แพ้ยาซ้ำ').length;
            document.getElementById('stat-wrong').innerText = filteredRecords.filter(r => r.meType === 'จ่ายยาผิดคน').length;
            document.getElementById('stat-severe').innerText = filteredRecords.filter(r => r.meType === 'ME ระดับ E ขึ้นไป').length;
            const start = (currentPage - 1) * rowsPerPage;
            const pageData = filteredRecords.slice(start, start + rowsPerPage);
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = pageData.length ? pageData.map((r, i) => `<tr class="hover:bg-blue-50/50 cursor-pointer transition-colors border-b border-gray-50" onclick="openModal(${start + i})"><td class="px-4 py-4 whitespace-nowrap">${new Date(r.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' })}</td><td class="px-4 py-4 font-bold text-blue-600">${r.hn}</td><td class="px-4 py-4"><span class="type-badge ${getBadgeColor(r.meType)}">${r.meType}</span></td><td class="px-4 py-4 text-gray-500 truncate max-w-[200px]">${r.details}</td><td class="px-4 py-4 text-center"><span class="severity-badge ${getSeverityClass(r.severity)}">${(r.severity || "").split(" ")[0]}</span></td></tr>`).join('') : `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">ไม่พบข้อมูล</td></tr>`;
            document.getElementById('pageIndicator').innerText = `${currentPage} / ${Math.ceil(filteredRecords.length / rowsPerPage) || 1}`;
            renderCharts();
        }
        function getBadgeColor(type) { if (type.includes('แพ้')) return 'bg-teal-500'; if (type.includes('ผิดคน')) return 'bg-pink-500'; return 'bg-orange-500'; }
        // Updated color logic
        function getSeverityClass(sev) {
            const s = (sev || "").charAt(0);
            if (['A', 'B'].includes(s)) return 'bg-gray-100 text-gray-600 border-gray-300';
            if (['C', 'D'].includes(s)) return 'bg-green-100 text-green-700 border-green-300';
            if (['E', 'F'].includes(s)) return 'bg-yellow-100 text-yellow-700 border-yellow-300';
            if (['G', 'H'].includes(s)) return 'bg-orange-100 text-orange-700 border-orange-300';
            if (['I'].includes(s)) return 'bg-red-100 text-red-700 border-red-300';
            return 'bg-gray-100 text-gray-600 border-gray-300';
        }
        function changePage(d) { const max = Math.ceil(filteredRecords.length / rowsPerPage); if ((currentPage + d) >= 1 && (currentPage + d) <= max) { currentPage += d; renderDashboard(); } }
        let chartInstances = {};
        function renderCharts() {
            const ctxType = document.getElementById('typeChart').getContext('2d');
            const ctxSev = document.getElementById('severityChart').getContext('2d');

            // Gradients for Pie Chart
            const tealGradient = ctxType.createLinearGradient(0, 0, 0, 300);
            tealGradient.addColorStop(0, '#2dd4bf'); tealGradient.addColorStop(1, '#0f766e');
            const pinkGradient = ctxType.createLinearGradient(0, 0, 0, 300);
            pinkGradient.addColorStop(0, '#f472b6'); pinkGradient.addColorStop(1, '#be185d');
            const orangeGradient = ctxType.createLinearGradient(0, 0, 0, 300);
            orangeGradient.addColorStop(0, '#fb923c'); orangeGradient.addColorStop(1, '#c2410c');

            // Gradient for Bar Chart (Blue)
            const blueGradient = ctxSev.createLinearGradient(0, 0, 0, 300);
            blueGradient.addColorStop(0, '#60a5fa'); blueGradient.addColorStop(1, '#1e3a8a');

            const types = { 'แพ้ยาซ้ำ': 0, 'จ่ายยาผิดคน': 0, 'ME ระดับ E ขึ้นไป': 0 };
            filteredRecords.forEach(r => { if (types[r.meType] !== undefined) types[r.meType]++ });

            const sevs = {};
            filteredRecords.forEach(r => { const s = (r.severity || "").split(" ")[0]; if (s) sevs[s] = (sevs[s] || 0) + 1 });

            // Calculate Total for Percentage
            const totalRecords = filteredRecords.length;
            const sevKeys = Object.keys(sevs).sort();
            const sevCounts = sevKeys.map(k => sevs[k]);
            const sevPercentages = sevKeys.map(k => totalRecords > 0 ? ((sevs[k] / totalRecords) * 100).toFixed(1) : 0);

            if (chartInstances.type) chartInstances.type.destroy();
            chartInstances.type = new Chart(ctxType, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(types),
                    datasets: [{
                        data: Object.values(types),
                        backgroundColor: [tealGradient, pinkGradient, orangeGradient],
                        borderWidth: 2,
                        borderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { family: 'Sarabun', size: 12 },
                                usePointStyle: true,
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const meta = chart.getDatasetMeta(0);
                                            const style = meta.controller.getStyle(i);
                                            return {
                                                text: `${label}`, // Removed percentage from legend
                                                fillStyle: style.backgroundColor,
                                                strokeStyle: style.borderColor,
                                                lineWidth: style.borderWidth,
                                                hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { family: 'Sarabun', weight: 'bold', size: 14 },
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => { sum += data; });
                                if (sum === 0) return "";
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            },
                            display: (context) => {
                                return context.dataset.data[context.dataIndex] > 0;
                            },
                            // Add shadow to text for readability
                            textShadowBlur: 4,
                            textShadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            });

            if (chartInstances.sev) chartInstances.sev.destroy();
            chartInstances.sev = new Chart(ctxSev, {
                type: 'bar',
                data: {
                    labels: sevKeys,
                    datasets: [{
                        label: 'จำนวนครั้ง(%)',
                        data: sevPercentages,
                        backgroundColor: blueGradient,
                        borderRadius: 6,
                        borderWidth: 1,
                        borderColor: '#fff',
                        // Shadow for bar
                        shadowOffsetX: 2,
                        shadowOffsetY: 2,
                        shadowBlur: 5,
                        shadowColor: 'rgba(0, 0, 0, 0.3)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const index = context.dataIndex;
                                    const count = sevCounts[index];
                                    const percentage = context.parsed.y;
                                    return `${count} ครั้ง (${percentage}%)`; // Format tooltip: 5 ครั้ง (20%)
                                }
                            }
                        },
                        datalabels: {
                            color: '#4b5563',
                            anchor: 'end',
                            align: 'top',
                            font: { family: 'Sarabun', size: 11, weight: 'bold' },
                            formatter: (value, ctx) => {
                                const index = ctx.dataIndex;
                                const count = sevCounts[index];
                                if (count === 0) return "";
                                return `${count} ครั้ง (${value}%)`; // Format data label: 5 ครั้ง (20%)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            // max: 100, // Removed
                            grid: { color: '#f3f4f6' },
                            ticks: { callback: function (value) { return value + "%" } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { weight: 'bold' } } // Make X-axis labels bold
                        }
                    },
                    layout: {
                        padding: { top: 30 }
                    }
                }
            });
        }
        function openModal(index) {
            currentRecord = filteredRecords[index];
            document.getElementById('modalDate').innerText = new Date(currentRecord.date).toLocaleDateString('th-TH', { dateStyle: 'long' });
            document.getElementById('modalHN').innerText = currentRecord.hn;
            document.getElementById('modalReporter').innerText = currentRecord.reporter;
            document.getElementById('modalTypeContainer').innerHTML = `<span class="type-badge ${getBadgeColor(currentRecord.meType)}">${currentRecord.meType}</span>`;
            document.getElementById('modalSeverity').innerHTML = `<span class="severity-badge ${getSeverityClass(currentRecord.severity)} text-lg w-10 h-10">${(currentRecord.severity || "").split(" ")[0]}</span>`;
            document.getElementById('modalDetails').innerText = currentRecord.details;
            const gallery = document.getElementById('modalGallery');
            if (currentRecord.imageUrl && currentRecord.imageUrl !== "-") {
                gallery.innerHTML = currentRecord.imageUrl.split(',').map(url => `<div class="relative w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden border border-gray-200 cursor-pointer" onclick="openImageViewer('${convertDriveLink(url, 's0')}')"><img src="${convertDriveLink(url, 'w400')}" class="w-full h-full object-cover"></div>`).join('');
            } else { gallery.innerHTML = '<span class="text-xs text-gray-400 italic py-2">ไม่มีรูปภาพประกอบ</span>'; }
            document.getElementById('detailModal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }

        // Updated styling for Swal
        async function verifyPin() {
            const { value: pin } = await Swal.fire({
                title: 'ยืนยันรหัสผ่าน',
                input: 'password',
                inputAttributes: { maxlength: 4 },
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#9ca3af',
                customClass: {
                    popup: 'rounded-2xl',
                    confirmButton: 'rounded-xl',
                    cancelButton: 'rounded-xl',
                    input: 'rounded-xl'
                }
            });
            return pin === "1234";
        }

        async function deleteRecord() {
            if (await verifyPin()) {
                Swal.fire({
                    title: 'ยืนยันลบ?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#9ca3af',
                    confirmButtonText: 'ลบข้อมูล',
                    cancelButtonText: 'ยกเลิก',
                    customClass: {
                        popup: 'rounded-2xl',
                        confirmButton: 'rounded-xl',
                        cancelButton: 'rounded-xl'
                    }
                }).then(async (res) => {
                    if (res.isConfirmed) {
                        await window.deleteFromFirestore(currentRecord.rowId);
                        closeModal();
                        loadDashboardData();
                        Swal.fire({ icon: 'success', title: 'ลบเสร็จสิ้น', confirmButtonColor: '#2563eb', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } });
                    }
                });
            } else {
                Swal.fire({ icon: 'error', title: 'รหัสผิด', confirmButtonColor: '#2563eb', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } });
            }
        }

        async function editRecord() {
            if (await verifyPin()) {
                closeModal();
                switchTab('form');
                document.getElementById('editRowId').value = currentRecord.rowId;
                document.getElementById('incidentDate').value = currentRecord.date;
                document.getElementById('hnInput').value = currentRecord.hn;
                document.getElementById('reporter').value = currentRecord.reporter;
                document.getElementById('meDetails').value = currentRecord.details;
                document.getElementById('severity').value = currentRecord.severity.split(" ")[0];
                const types = { 'แพ้ยาซ้ำ': 1, 'จ่ายยาผิดคน': 2, 'ME ระดับ E ขึ้นไป': 3 };
                const typeId = types[currentRecord.meType];
                const btns = document.querySelectorAll('.btn-type');
                if (typeId) selectType(currentRecord.meType, typeId, btns[typeId - 1]);
                uploadedFiles = (currentRecord.imageUrl && currentRecord.imageUrl !== "-") ? currentRecord.imageUrl.split(',') : [];
                renderPreviews();
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-2"></i> อัปเดตข้อมูล';
                document.getElementById('submitBtn').className = "flex-1 py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold shadow-lg hover:shadow-yellow-500/30 transition-all hover:-translate-y-0.5 active:scale-95";
            } else {
                Swal.fire({ icon: 'error', title: 'รหัสผิด', confirmButtonColor: '#2563eb', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } });
            }
        }

        let imgScale = 1, imgTranslateX = 0, imgTranslateY = 0, isDraggingImg = false, startDragX = 0, startDragY = 0;
        function openImageViewer(url) { const modal = document.getElementById('imageViewerModal'); const img = document.getElementById('fullImage'); const loader = document.getElementById('imageLoader'); img.src = url; img.style.opacity = '0'; loader.classList.remove('hidden'); img.onload = () => { loader.classList.add('hidden'); img.style.opacity = '1'; }; resetZoom(); modal.classList.remove('hidden'); }
        function closeImageViewer() { document.getElementById('imageViewerModal').classList.add('hidden'); }
        function adjustZoom(delta) { imgScale = Math.max(0.5, Math.min(5, imgScale + delta)); updateTransform(); }
        function resetZoom() { imgScale = 1; imgTranslateX = 0; imgTranslateY = 0; updateTransform(); }
        function updateTransform() { document.getElementById('fullImage').style.transform = `translate(${imgTranslateX}px, ${imgTranslateY}px) scale(${imgScale})`; }
        function startDrag(e) { if (imgScale <= 1) return; isDraggingImg = true; startDragX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; startDragY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY; e.preventDefault(); }
        function drag(e) { if (!isDraggingImg) return; e.preventDefault(); const cx = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; const cy = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY; imgTranslateX += cx - startDragX; imgTranslateY += cy - startDragY; startDragX = cx; startDragY = cy; updateTransform(); }
        function endDrag() { isDraggingImg = false; }
        function startScanner() { document.getElementById('scannerModal').classList.remove('hidden'); if (!html5QrCode) html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => { document.getElementById('hnInput').value = decodedText; stopScanner(); Swal.fire({ icon: 'success', title: 'สแกนสำเร็จ', timer: 1000, showConfirmButton: false, confirmButtonColor: '#2563eb', customClass: { popup: 'rounded-2xl', confirmButton: 'rounded-xl' } }); }, (err) => { }); }
        function stopScanner() { if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear()); document.getElementById('scannerModal').classList.add('hidden'); }
        document.getElementById('dropArea').addEventListener('click', () => document.getElementById('fileInput').click());
        // Removed auto-date
        loadDashboardData();
    </script>
</body>

</html>